
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Chosen Palette: Indigo Twilight Gradient -->
    <!-- Application Structure Plan: The application uses a task-oriented Single Page Application (SPA) model. The structure is designed for a clear user flow: a public landing page for introduction, dedicated login/register screens, and a role-based dashboard for authenticated users. The dashboard utilizes a tabbed navigation system to logically separate distinct user functions (e.g., equipment management, borrowing tasks, technician queues, approvals, reporting). This structure was chosen because it cleanly separates contexts, prevents information overload, and allows users to focus on specific tasks based on their roles. Interactions like creating requests or performing inspections are handled in modals to maintain context and avoid page reloads, creating a seamless and efficient user experience. -->
    <!-- Visualization & Content Choices: 
        - Equipment/User Summaries -> Goal: Inform -> Viz: Key Stats Cards (HTML/Tailwind) -> Interaction: Static -> Justification: Provides a quick, at-a-glance overview of system status.
        - Monthly Borrowing Data -> Goal: Show Change -> Viz: Bar Chart (Chart.js/Canvas) -> Interaction: Static -> Justification: Effectively visualizes trends in borrowing activity over time.
        - Equipment/User/Task Lists -> Goal: Organize & Act -> Viz: Interactive Card/Table Lists (HTML/Tailwind) -> Interaction: Search, Filter, Sort, Click actions -> Justification: Allows users to efficiently find information and perform tasks directly from the list view.
        - Complex Workflows (e.g., Inspections, Repair Logs) -> Goal: Guide User Process -> Viz: Form Modals (HTML/Tailwind) -> Interaction: User Input -> Justification: Breaks down complex tasks into manageable, focused steps without cluttering the main UI.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Yonchuw ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Thai', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        }
        .bg-grad {
            background: radial-gradient(1200px 600px at 80% -10%, rgba(79, 70, 229, .18), transparent 60%), linear-gradient(135deg, #0ea5e9 0%, #2563eb 50%, #7c3aed 100%);
        }
        .glass {
            backdrop-filter: saturate(140%) blur(10px);
            background: rgba(255, 255, 255, 0.08);
        }
        .card {
            background: rgba(255, 255, 255, 0.96);
        }
        .fade-in {
            animation: fade .35s ease-out;
        }
        @keyframes fade {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chip {
            background: rgba(99, 102, 241, .12);
            color: #4338ca;
            font-weight: 500;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .prose { color: #334155; }
        .prose h1, .prose h2, .prose h3, .prose h4 { color: #1e293b; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose strong { color: #1e293b; }
        .prose ul { margin-top: 0.5em; }
        .prose li { margin-top: 0.25em; margin-bottom: 0.25em; }
        .notification-dot::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ef4444;
            border: 2px solid white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        
        @media (max-width: 767px) {
            .max-w-7xl, .max-w-xl, .max-w-md, .max-w-4xl { padding-left: 1rem !important; padding-right: 1rem !important; }
            .md-stack > * { width: 100% !important; }
            .md-stack { flex-direction: column !important; align-items: stretch !important; }
            .grid-mobile-1 { grid-template-columns: 1fr !important; }
            header .flex.justify-between { flex-direction: row !important; align-items: center !important; }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="min-h-screen bg-grad text-white transition-all duration-300">
    <header class="sticky top-0 z-30 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="show('home')">
                <div class="w-9 h-9 rounded-xl bg-white/20 flex items-center justify-center">
                    <span class="text-2xl text-white">üîÑ</span>
                </div>
                <div>
                    <p class="font-semibold text-lg">Yonchuw</p>
                    <p class="text-white/80 text-xs -mt-0.5">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="notificationArea" class="relative hidden">
                    <button id="notificationBtn" class="p-2 rounded-full hover:bg-white/20 transition-colors text-2xl">
                       <span>üîî</span>
                    </button>
                    <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg text-slate-800 z-50 text-sm">
                        <div class="p-3 font-semibold border-b">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                        <div id="notificationList" class="p-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
                <nav class="hidden md:flex items-center gap-2" id="nav-actions">
                    <button id="btnLogin" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="btnRegister" class="px-4 py-2 rounded-lg bg-white text-slate-900 font-semibold hover:opacity-90 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                    <div id="userInfo" class="hidden items-center gap-3">
                        <span id="userNameDisplay" class="text-sm font-medium"></span>
                        <button id="btnLogout" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/40 transition text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </nav>
                <button id="hamburgerBtn" class="md:hidden p-2 rounded-lg bg-white/10 hover:bg-white/20 text-2xl">
                    <span>‚ò∞</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section id="home" class="fade-in">
            <div class="grid md:grid-cols-2 gap-8 items-start md-stack">
                <div>
                    <h1 class="text-4xl sm:text-5xl font-bold leading-tight tracking-tighter">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h1>
                    <p class="mt-4 text-lg text-white/90">‡∏•‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</p>
                    <div class="mt-8 flex flex-wrap gap-4">
                        <button id="startBtn" class="px-6 py-3 rounded-xl bg-white text-slate-900 font-semibold hover:opacity-90 transition-transform hover:scale-105">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                        <button id="browseBtn" class="px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 transition">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</button>
                    </div>
                    <div class="mt-6 flex items-center gap-3 text-sm">
                        <span class="chip px-3 py-1 rounded-full">Responsive</span>
                        <span class="chip px-3 py-1 rounded-full">Role-based</span>
                        <span class="chip px-3 py-1 rounded-full">Real-time</span>
                    </div>
                </div>
                <div class="card rounded-2xl p-6 text-slate-900 shadow-xl">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</p>
                        <span class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 font-medium">Demo</span>
                    </div>
                    <ol class="mt-4 space-y-2.5 text-sm text-slate-700 list-decimal list-inside">
                        <li><strong>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‚Üí ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù</li>
                        <li><strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ‚Üí ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</li>
                        <li><strong>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°:</strong> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</li>
                        <li><strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</strong> ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‚Üí ‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</li>
                        <li><strong>‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤ ‚Äú‡πÄ‡∏™‡∏µ‡∏¢/‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‚Äù</li>
                        <li><strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°:</strong> ‡∏´‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢ ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° ‚Üí ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏° ‚Üí ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à ‚Üí ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‚Äú‡∏ß‡πà‡∏≤‡∏á‚Äù</li>
                    </ol>
                    <div class="mt-5 p-3 rounded-lg bg-slate-50 border text-sm text-slate-600">
                        <strong>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: password)</strong>
                        <ul class="list-disc list-inside mt-1">
                            <li>admin@example.com (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</li>
                            <li>approver@example.com (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</li>
                            <li>tech@example.com (‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ)</li>
                            <li>user@example.com (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="equipmentShowcase" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6">
                <button id="backFromEquip" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">
                    <span class="text-lg">‚Üê</span>
                    ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                </button>
                <h2 class="text-xl font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div></div>
            </div>
            <div class="card rounded-2xl p-6 text-slate-900">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <div class="flex items-center gap-2">
                        <input id="equipSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ Serial" class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <select id="equipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="available">‡∏ß‡πà‡∏≤‡∏á</option>
                            <option value="borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                            <option value="under_maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                        </select>
                    </div>
                    <button id="btnAddEquip" class="hidden px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                </div>
                <div id="equipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 grid-mobile-1"></div>
            </div>
        </section>

        <section id="loginPage" class="hidden fade-in">
            <div class="max-w-md mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <button id="backFromLogin" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
                <form id="loginForm" class="mt-6 space-y-4">
                    <input name="email" type="email" required placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="password" type="password" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <button type="submit" class="w-full px-4 py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
                <p class="mt-4 text-sm text-center text-slate-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" id="goRegister" class="font-medium text-indigo-600 hover:underline">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a></p>
            </div>
        </section>

        <section id="registerPage" class="hidden fade-in">
            <div class="max-w-xl mx-auto card rounded-2xl p-8 text-slate-900 shadow-xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                    <button id="backFromRegister" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
                <form id="registerForm" class="mt-6 grid sm:grid-cols-2 gap-4">
                    <input name="full_name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="agency" required placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="phone" type="tel" required placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <input name="email" type="email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <textarea name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" rows="2" class="sm:col-span-2 px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
                    <input name="password" type="password" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" minlength="8" class="sm:col-span-2 px-4 py-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <button type="submit" class="sm:col-span-2 px-4 py-3 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700 transition">‡∏¢‡∏∑‡∏ô‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
                <div class="mt-4 text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                </div>
            </div>
        </section>

        <section id="dashboard" class="hidden fade-in">
            <div id="demoModeBanner" class="hidden bg-yellow-400 text-yellow-900 p-3 mb-6 rounded-lg flex items-center justify-between shadow-lg">
                <div class="flex items-center gap-2">
                    <span class="text-xl">‚úì</span>
                    <span class="font-semibold text-sm">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Simulation Mode)</span>
                </div>
                <button id="exitDemoBtn" class="px-3 py-1 rounded-md bg-white/50 hover:bg-white/80 text-sm font-medium">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            </div>

            <div class="mt-4 overflow-x-auto hidden md:block">
                <div id="desktopTabs" class="inline-flex gap-1 bg-white/10 rounded-xl p-1"></div>
            </div>

            <div class="mt-6">
                <div id="equipmentTab" class="tab-content">
                    <div class="grid lg:grid-cols-3 gap-6 grid-mobile-1">
                        <div class="lg:col-span-2 card rounded-2xl p-6 text-slate-900">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <input id="dashEquipSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" class="px-3 py-2 w-32 rounded-lg border border-slate-200">
                                    <select id="dashEquipFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                                        <option value="all">‡∏ß‡πà‡∏≤‡∏á & ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                                        <option value="available">‡∏ß‡πà‡∏≤‡∏á</option>
                                        <option value="borrowed">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</option>
                                        <option value="under_maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                                        <option value="pending_repair_approval">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°</option>
                                        <option value="deleted">‡∏ñ‡∏π‡∏Å‡∏•‡∏ö (Admin)</option>
                                    </select>
                                    <select id="dashEquipTypeFilter" class="px-3 py-2 rounded-lg border border-slate-200">
                                        <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                    </select>
                                    <button id="btnAddEquipDash" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 hidden">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                </div>
                            </div>
                            <div id="bulkActionContainer" class="hidden my-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between flex-wrap gap-2">
                                <span id="bulkActionCount" class="text-sm font-medium text-indigo-800"></span>
                                <div class="flex gap-2">
                                    <button id="bulkEditStatusBtn" class="px-3 py-1 text-xs rounded-lg bg-white border border-slate-300 text-slate-700 hover:bg-slate-50">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                                    <button id="bulkDeleteBtn" class="px-3 py-1 text-xs rounded-lg bg-red-500 text-white hover:bg-red-600">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-[60vh] pr-2 -mr-2 mt-4">
                               <div id="dashEquipList" class="grid sm:grid-cols-2 gap-4 grid-mobile-1"></div>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900 space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
                                <div id="equipmentSummary" class="grid grid-cols-2 gap-4 mt-2"></div>
                            </div>
                            <div id="userSummaryContainer">
                                <h3 class="text-lg font-semibold">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                                <div id="userSummary" class="grid grid-cols-2 gap-4 mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="borrowTab" class="hidden tab-content">
                     <div class="card rounded-2xl p-6 text-slate-900" id="borrowFormContainer">
                        <h3 class="text-lg font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                        <form id="borrowForm" class="mt-4 space-y-3">
                            <div class="border rounded-lg p-2 max-h-48 overflow-y-auto">
                                <p class="text-sm font-medium mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°:</p>
                                <div id="borrowEquipTypeList" class="space-y-1"></div>
                            </div>
                            <div class="grid sm:grid-cols-2 gap-3">
                                <input type="date" name="borrow_date" id="borrowDate" class="px-3 py-2 rounded-lg border border-slate-200" required>
                                <input type="date" id="dueDate" class="px-3 py-2 rounded-lg border border-slate-200 bg-slate-50" readonly>
                            </div>
                            <input name="purpose" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" class="w-full px-3 py-2 rounded-lg border border-slate-200" required>
                            <div class="grid sm:grid-cols-2 gap-3">
                                <input name="contact_name" placeholder="‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô" class="px-3 py-2 rounded-lg border border-slate-200" required>
                                <input name="contact_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="px-3 py-2 rounded-lg border border-slate-200" required>
                            </div>
                            <textarea name="notes" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô)" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                            <button class="w-full px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                        </form>
                        <p class="text-xs text-slate-500 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</p>
                    </div>
                </div>

                <div id="borrowHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                         <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h3>
                            <div id="borrowHistoryFilter" class="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                                <button data-filter="all" class="px-3 py-1 text-sm rounded-md bg-white shadow">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button data-filter="borrowed" class="px-3 py-1 text-sm rounded-md">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</button>
                                <button data-filter="returned" class="px-3 py-1 text-sm rounded-md">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
                            </div>
                        </div>
                        <div id="myBorrowsHistory" class="mt-4 space-y-3"></div>
                    </div>
                </div>

                <div id="techTab" class="hidden tab-content">
                    <div class="grid lg:grid-cols-2 gap-6 grid-mobile-1">
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û (‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏∑‡∏ô)</h3>
                            <div id="techReturnQueue" class="mt-4 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</h3>
                                <button id="exportRepairsBtn" class="px-3 py-1 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">Export</button>
                            </div>
                            <div id="repairList" class="mt-4 space-y-3"></div>
                        </div>
                    </div>
                </div>
                
                <div id="deliveryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <h3 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö (Delivery Queue)</h3>
                        <p class="text-sm text-slate-600 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</p>
                        <div class="mt-4 overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th scope="col" class="px-4 py-3">ID ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</th>
                                        <th scope="col" class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                                        <th scope="col" class="px-4 py-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                                        <th scope="col" class="px-4 py-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryQueueTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <div id="repairHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                         <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                         <div id="allRepairsHistory" class="mt-4 space-y-3"></div>
                    </div>
                </div>

                <div id="approvalTab" class="hidden tab-content">
                    <div class="grid lg:grid-cols-2 gap-6 grid-mobile-1">
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                            <div id="approvalUsers" class="mt-3 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
                            <div id="approvalBorrowList" class="mt-3 space-y-3"></div>
                        </div>
                        <div class="card rounded-2xl p-6 text-slate-900 lg:col-span-2">
                            <h3 class="text-lg font-semibold">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>
                            <div id="approvalRepairList" class="mt-3 space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="approvalHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>
                        <div class="my-4 p-3 bg-slate-50 border border-slate-200 rounded-lg flex flex-wrap items-center gap-4 text-sm">
                            <div>
                                <label for="approvalHistoryActionFilter" class="font-medium text-slate-600 block mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select id="approvalHistoryActionFilter" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                </select>
                            </div>
                            <div>
                                <label for="approvalHistoryStartDate" class="font-medium text-slate-600 block mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="approvalHistoryStartDate" class="px-3 py-2 rounded-lg border border-slate-300">
                            </div>
                            <div>
                                <label for="approvalHistoryEndDate" class="font-medium text-slate-600 block mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="approvalHistoryEndDate" class="px-3 py-2 rounded-lg border border-slate-300">
                            </div>
                            <div>
                                <label for="approvalHistorySort" class="font-medium text-slate-600 block mb-1">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
                                <select id="approvalHistorySort" class="px-3 py-2 rounded-lg border border-slate-300 bg-white">
                                    <option value="newest">‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                    <option value="oldest">‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î</option>
                                </select>
                            </div>
                            <div class="self-end">
                                <button id="resetApprovalHistoryFiltersBtn" class="px-4 py-2 rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                            </div>
                        </div>
                        <div id="approvalHistoryList" class="mt-4"></div>
                    </div>
                </div>

                <div id="assessmentTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô</h3>
                            <div class="flex items-center gap-2">
                                <select id="assessmentTypeFilter" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û</p>
                        <div id="assessmentEquipList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 grid-mobile-1"></div>
                    </div>
                </div>
                 <div id="assessmentHistoryTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <h3 class="text-lg font-semibold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</h3>
                        <div id="assessmentHistoryList" class="mt-4 space-y-3"></div>
                    </div>
                </div>

                <div id="reportTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <h3 class="text-lg font-semibold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
                             <div class="flex items-center gap-2">
                                <input type="month" id="reportMonthFilter" class="px-3 py-2 text-sm rounded-lg border border-slate-200">
                                <button id="exportReportsBtn" class="px-4 py-2 text-sm rounded-lg bg-slate-200 text-slate-800 hover:bg-slate-300">Export</button>
                            </div>
                        </div>
                        <div id="reportCards" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-4 grid-mobile-1"></div>
                        <div class="mt-6 grid md:grid-cols-2 gap-6 grid-mobile-1">
                            <div class="chart-container">
                                <canvas id="borrowChart"></canvas>
                            </div>
                             <div class="chart-container">
                                <canvas id="repairCostChart"></canvas>
                            </div>
                        </div>
                         <div class="mt-8 border-t pt-6">
                            <h4 class="text-lg font-semibold mb-4">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</h4>
                            <div class="grid md:grid-cols-2 gap-6 grid-mobile-1">
                                <div>
                                    <h5 class="font-semibold mb-2 text-slate-800">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h5>
                                    <div id="mostRepairedList" class="text-sm"></div>
                                </div>
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="borrowByTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div id="technicianReportSection" class="hidden mt-8 border-t pt-6">
                            <h4 class="text-lg font-semibold mb-4">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</h4>
                            <div id="techReportCards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 grid-mobile-1"></div>
                            <div class="mt-6">
                                <h5 class="font-semibold mb-2 text-slate-800">‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                                <div id="frequentPartsList" class="text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminTab" class="hidden tab-content">
                    <div class="card rounded-2xl p-6 text-slate-900">
                        <div class="flex border-b mb-4">
                            <button id="adminSubTabUsersBtn" class="px-4 py-2 border-b-2 border-indigo-500 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                            <button id="adminSubTabGroupsBtn" class="px-4 py-2 text-slate-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
                            <button id="adminSubTabLogBtn" class="px-4 py-2 text-slate-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</button>
                        </div>
                        <div id="adminSubContentUsers">
                           <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                               <div class="flex items-center gap-2 flex-wrap">
                                   <input id="adminUserSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm">
                                   <select id="adminUserRoleFilter" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
                                       <option value="">‡∏ó‡∏∏‡∏Å‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</option>
                                   </select>
                                   <select id="adminUserStatusFilter" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
                                       <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                                       <option value="active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                       <option value="pending_approval">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                                       <option value="deleted">‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</option>
                                   </select>
                               </div>
                               <button id="adminAddUserBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
                           </div>
                           <div class="overflow-x-auto">
                               <table class="w-full text-sm text-left text-slate-500">
                                   <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                       <tr>
                                           <th scope="col" class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                           <th scope="col" class="px-4 py-3">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                           <th scope="col" class="px-4 py-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                           <th scope="col" class="px-4 py-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                           <th scope="col" class="px-4 py-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                       </tr>
                                   </thead>
                                   <tbody id="adminUserList"></tbody>
                               </table>
                           </div>
                        </div>
                        <div id="adminSubContentGroups" class="hidden">
                           <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                               <p class="font-semibold">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
                               <button id="adminAddGroupBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                           </div>
                           <div id="adminGroupList" class="space-y-3"></div>
                        </div>
                        <div id="adminSubContentLog" class="hidden">
                             <div class="mb-4">
                                <input id="adminLogSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full md:w-1/3 px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-sm">
                            </div>
                            <div class="overflow-x-auto max-h-96">
                                <table class="w-full text-sm text-left text-slate-500">
                                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                            <th scope="col" class="px-4 py-3">‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                            <th scope="col" class="px-4 py-3">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                                            <th scope="col" class="px-4 py-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminActivityLog"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="sidebar" class="fixed inset-0 z-40 md:hidden hidden">
        <div id="sidebarBackdrop" class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300"></div>
        <div id="sidebarContent" class="relative z-10 w-64 bg-slate-800 text-white h-full p-4 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-semibold text-lg">‡πÄ‡∏°‡∏ô‡∏π</h3>
                <button id="sidebarCloseBtn" class="p-2 text-2xl leading-none">&times;</button>
            </div>
            <nav id="sidebarNav" class="flex flex-col gap-2"></nav>
            <div class="mt-auto pt-6 border-t border-white/10">
                <div id="sidebarUserInfo" class="hidden flex-col items-start gap-1">
                    <span id="sidebarUserNameDisplay" class="text-sm font-semibold"></span>
                    <span id="sidebarUserRoleDisplay" class="text-xs px-2 py-0.5 rounded-full bg-white/10 text-white"></span>
                    <button id="reportProblemBtn" class="mt-4 text-left w-full text-sm text-slate-300 hover:text-white">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="sidebarBtnLogout" class="mt-2 px-4 py-2 rounded-lg bg-red-500/20 text-red-100 hover:bg-red-500/40 transition text-sm w-full">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <div id="sidebarLoginActions">
                    <button id="sidebarBtnLogin" class="w-full px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button id="sidebarBtnRegister" class="mt-2 w-full px-4 py-2 rounded-lg bg-white text-slate-900 font-semibold hover:opacity-90 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 transition-opacity duration-300">
        <div id="modalContent" class="bg-white rounded-2xl p-6 text-slate-900 w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex items-center justify-between">
                <h3 id="modalTitle" class="text-xl font-bold">Modal Title</h3>
                <button id="modalClose" class="text-2xl leading-none text-slate-400 hover:text-slate-800">&times;</button>
            </div>
            <div id="modalBody" class="mt-4"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg hidden transition-all duration-300"></div>

    <footer class="text-center py-8 px-4 text-white/60 text-xs">
        <div class="max-w-4xl mx-auto border-t border-white/20 pt-8">
            <p class="font-semibold">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ô‡∏≥‡πÇ‡∏î‡∏¢‡πÅ‡∏°‡∏•‡∏á‡∏ó‡∏µ‡πà 12.4.4</p>
            <p>11 ‡∏ñ‡∏ô‡∏ô‡∏£‡∏∞‡πÅ‡∏á‡∏∞‡∏°‡∏£‡∏£‡∏Ñ‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏ô‡∏≤‡∏Ñ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ 96000</p>
            <p>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: 073-514-960</p>
        </div>
    </footer>

    <script>
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const show = (id) => {
            $$('main section').forEach(s => s.classList.add('hidden'));
            const section = $(`#${id}`);
            if (section) { section.classList.remove('hidden'); }
        };
        const hideModal = () => {
            $('#modal').style.opacity = '0';
            $('#modalContent').classList.add('scale-95');
            setTimeout(() => {
                $('#modal').classList.add('hidden');
                $('#modalContent').classList.remove('max-w-3xl'); // Reset modal width
            }, 300);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                user: null,
                selectedEquipment: new Set(),
                equipment: [
                    { id: 1, serial: '0334 0418 0044', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 2, serial: '0334 0418 0045', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 3, serial: '0334 0418 0046', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 4, serial: '0334 0418 0047', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 5, serial: '0334 0418 0048', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 6, serial: '0334 0418 0049', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 7, serial: '0334 0418 0050', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 8, serial: '0334 0418 0051', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 9, serial: '0334 0418 0052', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2008-01-25', status: 'available', notes: '', price: 2500 },
                    { id: 10, serial: '0334 0418 0061', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 11, serial: '0334 0418 0062', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 12, serial: '0334 0418 0063', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2008-10-21', status: 'available', notes: '', price: 2500 },
                    { id: 13, serial: '0334 0418 0087', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 14, serial: '0334 0418 0088', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 15, serial: '0334 0418 0089', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2009-07-09', status: 'available', notes: '', price: 2500 },
                    { id: 16, serial: '0334 0461 01160 0106', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 17, serial: '0334 0461 01160 0107', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 18, serial: '0334 0461 01160 0108', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2018-01-11', status: 'available', notes: '', price: 2500 },
                    { id: 19, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0124', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2020-10-19', status: 'borrowed', notes: '', price: 3200 },
                    { id: 20, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0125', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2020-10-19', status: 'borrowed', notes: '', price: 3200 },
                    { id: 21, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0126', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2020-10-19', status: 'borrowed', notes: '', price: 3200 },
                    { id: 22, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0863 0127', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2020-10-19', status: 'available', notes: '', price: 3200 },
                    { id: 23, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0140', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2022-09-28', status: 'available', notes: '', price: 3200 },
                    { id: 24, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0141', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2022-09-28', status: 'pending_repair_approval', notes: '‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', price: 3200 },
                    { id: 25, serial: '‡∏™‡∏Ñ‡∏£.0334 0429 0465 0142', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2022-09-28', status: 'borrowed', notes: '', price: 3200 },
                    { id: 26, serial: '51 6640 007 00005 (67)', name: 'Micron CS10', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2024-05-14', status: 'borrowed', notes: '', price: 15000 },
                    { id: 27, serial: '0332 048 0001 (8551)', name: 'SWING FOG SN 11 P', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '1997-06-13', status: 'available', notes: '', price: 45000 },
                    { id: 28, serial: '0332 048 0001 (8666)', name: 'SWING FOG SN 50', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '1997-06-13', status: 'available', notes: '', price: 45000 },
                    { id: 29, serial: '0332 012.4 0010 (NR070542604)', name: 'IGEBA PORT 123 ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2006-02-18', status: 'available', notes: '', price: 68000 },
                    { id: 30, serial: '0332 012.4 0011 (NR070545004)', name: 'IGEBA PORT 123 ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2006-02-18', status: 'under_maintenance', notes: '‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', price: 68000 },
                    { id: 31, serial: '0332 012.4 0012', name: 'SWING FOG SN50', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2006-11-30', status: 'available', notes: '', price: 45000 },
                    { id: 32, serial: '0332 00418 00049', name: 'ULV Leco 1800 E', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2009-05-25', status: 'available', notes: '', price: 250000 },
                    { id: 33, serial: '0332 0418 0098 (TL 060545)', name: 'TWISTER XL BY DYNAFOG', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ù‡∏≠‡∏¢', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2015-08-05', status: 'pending_repair_approval', notes: '‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î', price: 22000 },
                    { id: 34, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0105 (154710)', name: 'Swingtec ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-05-10', status: 'available', notes: '', price: 75000 },
                    { id: 35, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0104 (154714)', name: 'Swingtec ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2016-05-29', status: 'available', notes: '', price: 75000 },
                    { id: 36, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0121', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 37, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0122', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 38, serial: '‡∏™‡∏Ñ‡∏£.0332 0418 0126', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2016-11-29', status: 'available', notes: '', price: 35000 },
                    { id: 39, serial: '0334 0461 1260', name: 'Misuko 3WF-3A', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2018-01-12', status: 'available', notes: '', price: 4000 },
                    { id: 40, serial: '0332 0461 11600124', name: 'Swingtac ULV', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á ULV', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2018-01-12', status: 'available', notes: '', price: 75000 },
                    { id: 41, serial: 'XYZ-001', name: 'FONTAN PORTASTARS', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏î‡∏°.', acquisition_date: '2023-01-15', status: 'available', notes: '', price: 35000 },
                    { id: 42, serial: 'XYZ-002', name: 'SWING FOG SN50', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏±‡∏ô', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2023-02-20', status: 'under_maintenance', notes: '‡∏´‡∏±‡∏ß‡∏û‡πà‡∏ô‡∏ï‡∏±‡∏ô', price: 45000 },
                    { id: 43, serial: 'XYZ-003', name: 'HUDSON X-PERT SPRAYER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.2', acquisition_date: '2023-03-10', status: 'available', notes: '', price: 2500 },
                    { id: 44, serial: 'XYZ-004', name: 'Micron CS10', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡∏ù‡∏≠‡∏¢‡∏•‡∏∞‡∏≠‡∏≠‡∏á', department: '‡∏®‡∏ï‡∏°.', acquisition_date: '2023-04-05', status: 'available', notes: '', price: 15000 },
                    { id: 45, serial: 'XYZ-005', name: 'IK VECTOR CONTROL SUPER', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÄ‡∏Ñ‡∏°‡∏µ‡∏≠‡∏±‡∏î‡∏•‡∏°', department: '‡∏ô‡∏Ñ‡∏°.3', acquisition_date: '2023-05-15', status: 'available', notes: '', price: 3200 }
                ],
                borrows: [
                    { id: 1, equipment_ids: [19], user_id: 4, user_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', borrow_date: '2025-09-10', due_date: '2025-09-17', return_date: null, purpose: '‡∏û‡πà‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏®‡∏£‡∏µ', contact_phone: '081-234-5678', notes: '‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢', status: 'borrowed' },
                    { id: 2, equipment_ids: [20, 21], user_id: 6, user_name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ', borrow_date: '2025-09-08', due_date: '2025-09-15', return_date: null, purpose: '‡∏û‡πà‡∏ô‡∏¢‡∏∏‡∏á‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÅ‡∏≠‡∏≠‡∏±‡∏î', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ô‡∏µ', contact_phone: '082-345-6789', notes: '', status: 'pending_delivery' },
                    { id: 3, equipment_ids: [22], user_id: 4, user_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', borrow_date: '2025-08-01', due_date: '2025-08-08', return_date: '2025-08-10', actual_return_date: '2025-08-10', late_return_reason: '‡∏ï‡∏¥‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏î‡πà‡∏ß‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏≤‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô', status: 'returned_late', notes: '', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏®‡∏£‡∏µ', contact_phone: '081-234-5678', purpose: '‡∏û‡πà‡∏ô‡∏¢‡∏∏‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
                    { id: 4, equipment_ids: [24], user_id: 6, user_name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ', borrow_date: '2025-08-15', due_date: '2025-08-22', return_date: '2025-08-22', actual_return_date: '2025-08-22', purpose: '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ô‡∏µ', contact_phone: '082-345-6789', status: 'returned_damaged' },
                    { id: 5, equipment_ids: [25, 26], user_id: 4, user_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', borrow_date: '2025-09-12', due_date: '2025-09-19', return_date: null, purpose: '‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡πÉ‡∏ä‡πâ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', contact_name: '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏®‡∏£‡∏µ', contact_phone: '081-234-5678', notes: '', status: 'pending_borrow_approval' }
                ],
                repairs: [
                    { id: 1, equipment_id: 30, equipment_name: 'IGEBA PORT 123 ULV', damage_description: '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', status: 'repair_approved', technician_id: 3, repair_details: null, cost: null, parts_used: null, request_date: '2025-08-15', attachments: [] },
                    { id: 2, equipment_id: 33, equipment_name: 'TWISTER XL BY DYNAFOG', damage_description: '‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î', status: 'pending_repair_approval', technician_id: null, repair_details: null, cost: null, parts_used: null, request_date: '2025-08-18', attachments: [] },
                    { id: 3, equipment_id: 24, equipment_name: 'IK VECTOR CONTROL SUPER', damage_description: '‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ä‡∏∏‡∏î‡∏¢‡∏∑‡∏° #4)', status: 'pending_repair_approval', technician_id: null, repair_details: null, cost: null, parts_used: null, request_date: '2025-08-22', attachments: [] },
                    { id: 4, equipment_id: 10, equipment_name: 'HUDSON X-PERT SPRAYER', damage_description: '‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡∏ï‡∏Å', status: 'completed', technician_id: 3, repair_details: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î‡πÅ‡∏•‡∏∞‡∏ã‡∏µ‡∏•‡∏¢‡∏≤‡∏á O-ring ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏†‡∏≤‡∏û', cost: 850, parts_used: '‡∏´‡∏±‡∏ß‡∏â‡∏µ‡∏î, ‡∏ã‡∏µ‡∏•‡∏¢‡∏≤‡∏á O-ring', request_date: '2025-07-05', repair_date: '2025-07-08', attachments: [] },
                    { id: 5, equipment_id: 11, equipment_name: 'HUDSON X-PERT SPRAYER', damage_description: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö', status: 'completed', technician_id: 7, repair_details: '‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå', cost: 300, parts_used: '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå', request_date: '2025-07-10', repair_date: '2025-07-11', attachments: [] },
                    { id: 6, equipment_id: 42, equipment_name: 'SWING FOG SN50', damage_description: '‡∏´‡∏±‡∏ß‡∏û‡πà‡∏ô‡∏ï‡∏±‡∏ô', status: 'repair_approved', technician_id: 3, repair_details: null, cost: null, parts_used: null, request_date: '2025-09-01', attachments: [] }
                ],
                users: [
                    { id: 1, full_name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', email: 'admin@example.com', role: 'admin', status: 'active', agency: '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á', address: '-', phone: '0' },
                    { id: 2, full_name: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', email: 'approver@example.com', role: 'approver', status: 'active', agency: '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà', address: '-', phone: '0' },
                    { id: 3, full_name: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', email: 'tech@example.com', role: 'technician', status: 'active', agency: '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', address: '-', phone: '0' },
                    { id: 4, full_name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', email: 'user@example.com', role: 'user', status: 'active', agency: '‡∏≠‡∏ö‡∏ï. ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á', address: '123 ‡∏ñ.‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó', phone: '080-000-0000' },
                    { id: 6, full_name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ', email: 'user2@example.com', role: 'user', status: 'active', agency: '‡∏£‡∏û.‡∏™‡∏ï. ‡πÅ‡∏î‡∏ô‡∏™‡∏∏‡∏Ç', address: '789 ‡∏ñ.‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏≥‡∏£‡∏∏‡∏á', phone: '081-111-2222' },
                    { id: 7, full_name: '‡∏ä‡πà‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡πå', email: 'tech2@example.com', role: 'technician', status: 'active', agency: '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', address: '-', phone: '0' }
                ],
                pendingUsers: [
                    { id: 5, full_name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', email: 'somchai@example.com', role: 'user', status: 'pending_approval', agency: '‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£', address: '456 ‡∏ñ.‡πÄ‡∏û‡∏ä‡∏£‡πÄ‡∏Å‡∏©‡∏°', phone: '090-000-0000' },
                    { id: 8, full_name: '‡∏°‡∏≤‡∏ô‡∏∞ ‡∏≠‡∏î‡∏ó‡∏ô', email: 'newuser@example.com', role: 'user', status: 'pending_approval', agency: '‡∏≠‡∏ö‡∏à. ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏£‡∏∏‡∏á', address: '101 ‡∏ñ.‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û', phone: '092-333-4444' }
                ],
                groups: [
                    { id: 1, name: '‡∏ó‡∏µ‡∏° A', member_ids: [3, 4], permissions: ['CAN_VIEW_REPORTS'] },
                    { id: 2, name: '‡∏ó‡∏µ‡∏° B', member_ids: [], permissions: [] }
                ],
                assessments: [
                    { id: 1, equipment_id: 1, date: '2025-06-15', exterior_condition: 'mid', engine_start: 'easy', clean_pipe: true, clean_chem_line: true, clean_gas_tank: true, chem_name: 'Deltamethrin', chem_concentration: '2.5%', chem_mix_ratio: '1:25', result_temp: '55', result_flow_rate: '550', notes: '‡∏™‡∏†‡∏≤‡∏û‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏î‡∏µ' },
                    { id: 2, equipment_id: 28, date: '2025-06-20', exterior_condition: 'old', engine_start: 'hard', clean_pipe: true, chem_name: 'Cypermethrin', chem_concentration: '10%', chem_mix_ratio: '1:100', result_temp: '60', result_flow_rate: '600', notes: '‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô' }
                ],
                notifications: [
                    { id: 1, message: '‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', target: ['admin', 'approver'], timestamp: new Date('2025-09-11T10:00:00Z'), read: false },
                    { id: 2, message: '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #5 ‡∏à‡∏≤‡∏Å ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', target: ['admin', 'approver'], timestamp: new Date('2025-09-12T11:30:00Z'), read: false },
                    { id: 3, message: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á TWISTER XL BY DYNAFOG ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°', target: ['admin', 'approver'], timestamp: new Date('2025-09-12T09:00:00Z'), read: true }
                ],
                activityLog: [
                    { id: 1, admin_id: 2, admin_name: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', action: 'APPROVE_USER', target_type: 'user', target_id: 6, timestamp: '2025-09-01T09:05:00Z', details: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ' }
                ],
                seq: { borrow: 6, repair: 7, user: 9, equip: 46, assessment: 3, notification: 4, log: 2, group: 3 }
            };
            let audioCtx;
            
            function logActivity(action, target_type, target_id, details) {
                if (!state.user) return; 
                state.activityLog.unshift({
                    id: state.seq.log++,
                    admin_id: state.user.id,
                    admin_name: state.user.name,
                    action: action,
                    target_type: target_type,
                    target_id: target_id,
                    timestamp: new Date().toISOString(),
                    details: details,
                });
            }

            const api = {
                login: async (email, password) => {
                    const u = state.users.find(x => x.email === email);
                    if (!u || password !== 'password') throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    if (u.status !== 'active') throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    return { id: u.id, name: u.full_name, role: u.role };
                },
                register: async (data) => {
                    if (state.users.some(u => u.email === data.email) || state.pendingUsers.some(u => u.email === data.email)) throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    state.pendingUsers.push({ id: state.seq.user++, ...data, role: 'user', status: 'pending_approval' });
                    addNotification('‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', ['admin', 'approver']);
                    return { message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };
                },
                listAllUsers: async () => [...state.users, ...state.pendingUsers].sort((a, b) => a.id - b.id),
                listPendingUsers: async () => state.pendingUsers,
                approveUser: async (id) => {
                    const idx = state.pendingUsers.findIndex(u => u.id === id);
                    if (idx < 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');
                    const [u] = state.pendingUsers.splice(idx, 1);
                    state.users.push({ ...u, status: 'active' });
                    addNotification(`‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${u.full_name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, [u.id]);
                    logActivity('APPROVE_USER', 'user', id, `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${u.full_name}`);
                    return true;
                },
                rejectUser: async (id) => {
                    const user = state.pendingUsers.find(u => u.id === id);
                    state.pendingUsers = state.pendingUsers.filter(u => u.id !== id);
                    logActivity('REJECT_USER', 'user', id, `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user?.full_name || 'N/A'}`);
                    return true;
                },
                equipmentList: async (q = '', f = '', t = '') => {
                    let list = [...state.equipment];
                    if (state.user?.role !== 'admin' && f !== 'deleted') {
                        list = list.filter(e => e.status !== 'deleted');
                    }
                    if (q) list = list.filter(e => e.name.toLowerCase().includes(q.toLowerCase()) || e.serial.toLowerCase().includes(q.toLowerCase()));
                    if (f) {
                        if (f === 'all') {
                             list = list.filter(e => ['available', 'borrowed'].includes(e.status));
                        } else {
                            list = list.filter(e => e.status === f);
                        }
                    }
                    if (t) list = list.filter(e => e.type === t);
                    return list;
                },
                bulkAddEquipment: async (equipments) => {
                    const existingSerials = new Set(state.equipment.map(e => e.serial));
                    const newSerials = new Set(equipments.map(e => e.serial));
                    if (newSerials.size !== equipments.length) throw new Error('‡∏°‡∏µ Serial Number ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°');

                    for (const equip of equipments) {
                        if (existingSerials.has(equip.serial)) {
                            throw new Error(`Serial number '${equip.serial}' ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö`);
                        }
                    }
                    
                    const newIds = [];
                    equipments.forEach(data => {
                        const newEquip = { id: state.seq.equip++, ...data, status: 'available', acquisition_date: new Date().toISOString().slice(0, 10) };
                        state.equipment.push(newEquip);
                        newIds.push(newEquip.id);
                    });

                    logActivity('BULK_CREATE_EQUIPMENT', 'equipment', newIds.join(', '), `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${equipments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    addNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà ${equipments.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, ['admin', 'technician']);
                    return true;
                },
                updateEquipment: async (id, data) => {
                    const equip = state.equipment.find(e => e.id === id);
                    if (!equip) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');
                    const oldData = JSON.stringify(equip);
                    Object.assign(equip, data);
                    logActivity('UPDATE_EQUIPMENT', 'equipment', id, `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${equip.name}`);
                    return true;
                },
                deleteEquipment: async (id, reason) => {
                    const equip = state.equipment.find(e => e.id === id);
                    if (!equip) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');
                    equip.status = 'deleted';
                    equip.deletion_reason = reason;
                    equip.deleted_by = state.user.name;
                    equip.deleted_at = new Date().toISOString();
                    logActivity('DELETE_EQUIPMENT', 'equipment', id, `‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${equip.name} ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`);
                    return true;
                },
                 bulkDeleteEquipment: async (ids, reason) => {
                    ids.forEach(id => {
                        const equip = state.equipment.find(e => e.id === id);
                        if (equip) {
                            equip.status = 'deleted';
                            equip.deletion_reason = reason;
                            equip.deleted_by = state.user.name;
                            equip.deleted_at = new Date().toISOString();
                        }
                    });
                    logActivity('BULK_DELETE_EQUIPMENT', 'equipment', ids.join(', '), `‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`);
                    return true;
                },
                bulkUpdateEquipmentStatus: async (ids, status) => {
                    ids.forEach(id => {
                        const equip = state.equipment.find(e => e.id === id);
                        if (equip) {
                            equip.status = status;
                        }
                    });
                    logActivity('BULK_UPDATE_STATUS', 'equipment', ids.join(', '), `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${ids.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô: ${status}`);
                    return true;
                },
                createBorrow: async (payload) => {
                    const { equipment_requests, ...details } = payload;
                    if (!equipment_requests || equipment_requests.length === 0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
                    
                    const assigned_ids = [];
                    equipment_requests.forEach(req => {
                        const availableEquip = state.equipment.filter(e => e.type === req.type && e.status === 'available');
                        if (availableEquip.length < req.quantity) {
                            throw new Error(`‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "${req.type}" ‡∏°‡∏µ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${availableEquip.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á`);
                        }
                        assigned_ids.push(...availableEquip.slice(0, req.quantity).map(e => e.id));
                    });

                    const due = new Date(details.borrow_date);
                    due.setDate(due.getDate() + 7);
                    const due_date = due.toISOString().slice(0, 10);
                    state.borrows.push({
                        id: state.seq.borrow++, equipment_ids: assigned_ids, ...details, user_name: state.user.name, due_date, return_date: null, status: 'pending_borrow_approval'
                    });
                    addNotification(`‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å ${state.user.name}`, ['admin', 'approver']);
                    return true;
                },
                myBorrows: async (user_id) => state.borrows.filter(b => b.user_id === user_id).sort((a, b) => b.id - a.id),
                listBorrowRequests: async () => state.borrows.filter(b => b.status === 'pending_borrow_approval'),
                approveBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'pending_delivery';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`, ['admin', 'technician', b.user_id]);
                    logActivity('APPROVE_BORROW', 'borrow', id, `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏Ç‡∏≠‡∏á ${b.user_name}`);
                    return true;
                },
                adminCancelBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'cancelled';
                    b.equipment_ids.forEach(eid => {
                        const eq = state.equipment.find(e => e.id === eid);
                        if (eq) eq.status = 'available';
                    });
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢ Admin`, [b.user_id]);
                    logActivity('CANCEL_BORROW', 'borrow', id, `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏Ç‡∏≠‡∏á ${b.user_name}`);
                    return true;
                },
                performPreDeliveryCheck: async (id, replacements, checklistData) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.pre_delivery_checklist = checklistData;
                    
                    replacements.forEach(rep => {
                        const oldEquip = state.equipment.find(e => e.id === rep.faultyId);
                        if(oldEquip) oldEquip.status = 'pending_repair_approval';
                        state.repairs.push({ id: state.seq.repair++, equipment_id: oldEquip.id, equipment_name: oldEquip.name, damage_description: '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', status: 'pending_repair_approval', technician_id: null, request_date: new Date().toISOString().slice(0, 10), attachments: [] });
                        addNotification(`‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà ${oldEquip.name} ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö`, ['admin', 'approver']);
                        
                        const idx = b.equipment_ids.indexOf(rep.faultyId);
                        if(idx > -1) b.equipment_ids[idx] = rep.newId;
                    });
                    
                    b.status = 'borrowed';
                    b.equipment_ids.forEach(equip_id => {
                        const eq = state.equipment.find(e => e.id === equip_id);
                        if (eq) eq.status = 'borrowed';
                    });
                    addNotification(`‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, [b.user_id]);
                    return true;
                },
                rejectBorrow: async (id) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    b.status = 'rejected';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`, [b.user_id]);
                    logActivity('REJECT_BORROW', 'borrow', id, `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${id} ‡∏Ç‡∏≠‡∏á ${b.user_name}`);
                    return true;
                },
                queueForDelivery: async () => state.borrows.filter(b => b.status === 'pending_delivery'),
                queueForReturn: async () => state.borrows.filter(b => b.status === 'borrowed' && !b.return_date),
                techInspectReturn: async (id, isDamaged, notes, checklistData, lateReason, attachments = []) => {
                    const b = state.borrows.find(x => x.id === id);
                    if (!b) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    const today = new Date();
                    const dueDate = new Date(b.due_date);
                    b.actual_return_date = today.toISOString().slice(0, 10);
                    b.post_return_checklist = checklistData;
                    if (today > dueDate) {
                        b.late_return_reason = lateReason;
                        b.status = 'returned_late';
                    } else {
                        b.status = 'returned_early';
                    }
                    b.equipment_ids.forEach((equip_id) => {
                        const eq = state.equipment.find(e => e.id === equip_id);
                        if (!eq) return;
                        if (isDamaged) {
                            eq.status = 'pending_repair_approval';
                            state.repairs.push({ id: state.seq.repair++, equipment_id: eq.id, equipment_name: eq.name, damage_description: notes || `‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ä‡∏∏‡∏î‡∏¢‡∏∑‡∏° #${b.id})`, status: 'pending_repair_approval', request_date: new Date().toISOString().slice(0,10), attachments: attachments });
                            addNotification(`‡∏û‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${eq.name}`, ['admin', 'approver']);
                        } else {
                            eq.status = 'available';
                        }
                    });
                    if (isDamaged) b.status = 'returned_damaged';
                    addNotification(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${b.user_name} ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß`, ['admin', b.user_id]);
                    return true;
                },
                listRepairs: async () => state.repairs.sort((a, b) => b.id - a.id),
                listRepairRequests: async () => state.repairs.filter(r => r.status === 'pending_repair_approval'),
                approveRepair: async (id) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'repair_approved';
                    r.technician_id = state.user.role === 'technician' ? state.user.id : null;
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'under_maintenance';
                    addNotification(`‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° ${r.equipment_name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`, ['admin', 'technician']);
                    logActivity('APPROVE_REPAIR', 'repair', id, `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° #${id} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${r.equipment_name}`);
                    return true;
                },
                rejectRepair: async (id) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'repair_rejected';
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'available';
                    logActivity('REJECT_REPAIR', 'repair', id, `‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° #${id} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${r.equipment_name}`);
                    return true;
                },
                completeRepair: async (id, details) => {
                    const r = state.repairs.find(x => x.id === id);
                    if (!r) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                    r.status = 'completed';
                    const newAttachments = details.attachments || [];
                    delete details.attachments;
                    Object.assign(r, details);
                    if (!r.attachments) r.attachments = [];
                    r.attachments.push(...newAttachments);
                    const eq = state.equipment.find(e => e.id === r.equipment_id);
                    if (eq) eq.status = 'available';
                    addNotification(`${r.equipment_name} ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`, ['admin', 'approver']);
                    return true;
                },
                listAssessments: async () => state.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)),
                createAssessment: async (data) => {
                    state.assessments.push({ id: state.seq.assessment++, ...data, date: new Date().toISOString().slice(0, 10) });
                    return true;
                },
                getReportData: async (filterMonth) => {
                    const allBorrows = state.borrows;
                    const allRepairs = state.repairs;
                    const filteredBorrows = filterMonth ? allBorrows.filter(b => b.borrow_date.startsWith(filterMonth)) : allBorrows;
                    const filteredRepairs = filterMonth ? allRepairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : allRepairs;
                    
                    const completedRepairs = filteredRepairs.filter(r => r.status === 'completed' && r.cost);
                    const totalCost = completedRepairs.reduce((sum, r) => sum + Number(r.cost), 0);

                    const repairCounts = allRepairs.reduce((acc, r) => {
                        acc[r.equipment_id] = (acc[r.equipment_id] || 0) + 1;
                        return acc;
                    }, {});
                    const mostRepaired = Object.entries(repairCounts).sort(([,a],[,b]) => b-a).slice(0, 5).map(([id, count]) => {
                        const equip = state.equipment.find(e => e.id === parseInt(id));
                        return { name: equip?.name || 'N/A', serial: equip?.serial || 'N/A', count };
                    });
                    
                    const borrowingByType = allBorrows.flatMap(b => b.equipment_ids).reduce((acc, id) => {
                        const equip = state.equipment.find(e => e.id === id);
                        if (equip) {
                            acc[equip.type] = (acc[equip.type] || 0) + 1;
                        }
                        return acc;
                    }, {});

                    const completedRepairsWithDates = allRepairs.filter(r => r.status === 'completed' && r.request_date && r.repair_date);
                    let avgRepairTime = 0;
                    if (completedRepairsWithDates.length > 0) {
                        const totalTime = completedRepairsWithDates.reduce((sum, r) => {
                            const start = new Date(r.request_date);
                            const end = new Date(r.repair_date);
                            const diffTime = Math.abs(end - start);
                            return sum + Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        }, 0);
                        avgRepairTime = totalTime / completedRepairsWithDates.length;
                    }
                    
                    const pendingRepairs = allRepairs.filter(r => ['repair_approved', 'under_maintenance', 'pending_repair_approval'].includes(r.status)).length;

                    const frequentParts = allRepairs.filter(r => r.parts_used).flatMap(r => r.parts_used.split(/[,;\n]/).map(p => p.trim().toLowerCase())).reduce((acc, part) => {
                        if (part) acc[part] = (acc[part] || 0) + 1;
                        return acc;
                    }, {});
                    const top5Parts = Object.entries(frequentParts).sort(([,a],[,b]) => b-a).slice(0, 5);

                    return {
                        totalBorrows: filteredBorrows.length,
                        totalRepairs: filteredRepairs.length,
                        totalRepairCost: totalCost,
                        mostRepairedEquipment: mostRepaired,
                        borrowingByType: borrowingByType,
                        averageRepairTime: avgRepairTime,
                        pendingRepairsCount: pendingRepairs,
                        frequentlyUsedParts: top5Parts
                    };
                }
            };

            const toast = (msg, isError = false) => {
                const el = $('#toast');
                el.textContent = msg;
                el.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white text-sm font-medium shadow-lg transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-slate-800'}`;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 2500);
            };
            
            const setTabs = (tabId) => {
                $$('.tab-btn').forEach(b => {
                    const isSelected = b.dataset.tab === tabId;
                    b.classList.toggle('bg-white', isSelected);
                    b.classList.toggle('text-slate-900', isSelected);
                    b.classList.toggle('font-semibold', isSelected);
                    if (b.closest('#sidebarNav')) {
                        b.classList.toggle('bg-white/10', !isSelected);
                    } else {
                        b.classList.toggle('hover:bg-white/20', !isSelected);
                    }
                });
                $$('.tab-content').forEach(c => c.classList.toggle('hidden', c.id !== tabId));
                if (tabId !== 'equipmentTab' && state.selectedEquipment.size > 0) {
                    state.selectedEquipment.clear();
                    renderEquipmentLists();
                    updateBulkActionUI();
                }
            };
            const showModal = (title, content, actions) => {
                $('#modalTitle').textContent = title;
                $('#modalBody').innerHTML = content + (actions ? `<div class="mt-6 flex justify-end gap-3">${actions}</div>` : '');
                $('#modal').classList.remove('hidden');
                setTimeout(() => {
                    $('#modal').style.opacity = '1';
                    $('#modalContent').classList.remove('scale-95');
                }, 10);
            };
            
            const statusMap = {
                available: { text: '‡∏ß‡πà‡∏≤‡∏á', color: 'bg-emerald-100 text-emerald-800' },
                borrowed: { text: '‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', color: 'bg-indigo-100 text-indigo-800' },
                under_maintenance: { text: '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', color: 'bg-amber-100 text-amber-800' },
                pending_repair_approval: { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°', color: 'bg-rose-100 text-rose-800' },
                deleted: { text: '‡∏ñ‡∏π‡∏Å‡∏•‡∏ö', color: 'bg-slate-200 text-slate-600' }
            };
            const roleMap = { admin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', approver: '‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', technician: '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', user: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' };
            const approvalActionMap = {
                'APPROVE_USER': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'REJECT_USER': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ',
                'APPROVE_BORROW': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'REJECT_BORROW': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°',
                'CANCEL_BORROW': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', 'APPROVE_REPAIR': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°',
                'REJECT_REPAIR': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°'
            };

            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß";
                return "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
            }
            function playNotificationSound() {
                if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.5);
            }
            function addNotification(message, target) {
                state.notifications.unshift({ id: state.seq.notification++, message, target, timestamp: new Date(), read: false });
                playNotificationSound();
                renderNotifications();
            }
            function openNotifications() {
                const dropdown = $('#notificationDropdown');
                dropdown.classList.remove('hidden');
                
                const userNotifications = state.notifications.filter(n => (Array.isArray(n.target) && (n.target.includes(state.user.role) || n.target.includes(state.user.id))));
                const needsRender = userNotifications.some(n => !n.read);
                
                if (needsRender) {
                    userNotifications.forEach(n => { n.read = true; });
                    renderNotifications();
                }
            }
            function closeNotifications() {
                const dropdown = $('#notificationDropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }

            const getBorrowStatusTextAndColor = (status) => {
                switch (status) {
                    case 'pending_borrow_approval': return { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', color: 'bg-yellow-100 text-yellow-800' };
                    case 'pending_delivery': return { text: '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à', color: 'bg-cyan-100 text-cyan-800' };
                    case 'borrowed': return { text: '‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà', color: 'bg-blue-100 text-blue-800' };
                    case 'rejected': return { text: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', color: 'bg-red-100 text-red-800' };
                    case 'cancelled': return { text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', color: 'bg-gray-100 text-gray-800' };
                    case 'returned_early': return { text: '‡∏Ñ‡∏∑‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', color: 'bg-teal-100 text-teal-800' };
                    case 'returned_late': return { text: '‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤', color: 'bg-orange-100 text-orange-800' };
                    case 'returned': return { text: '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-green-100 text-green-800' };
                    case 'returned_damaged': return { text: '‡∏Ñ‡∏∑‡∏ô (‡∏ä‡∏≥‡∏£‡∏∏‡∏î)', color: 'bg-orange-100 text-orange-800' };
                    default: return { text: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', color: 'bg-gray-100 text-gray-800' };
                }
            }
            const getRepairStatusTextAndColor = (status) => {
                switch (status) {
                    case 'pending_repair_approval': return { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°', color: 'bg-yellow-100 text-yellow-800' };
                    case 'repair_approved': return { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', color: 'bg-blue-100 text-blue-800' };
                    case 'repair_rejected': return { text: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡πà‡∏≠‡∏°', color: 'bg-red-100 text-red-800' };
                    case 'completed': return { text: '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à', color: 'bg-green-100 text-green-800' };
                    default: return { text: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', color: 'bg-gray-100 text-gray-800' };
                }
            }

            async function renderEquipmentLists(options = {}) {
                const { forAssessment = false } = options;
                if (state.user && $('#dashEquipList')) {
                    const q2 = $('#dashEquipSearch')?.value || '';
                    const f2 = $('#dashEquipFilter')?.value || '';
                    const t2 = $('#dashEquipTypeFilter')?.value || '';
                    const list2 = await api.equipmentList(q2, f2, t2);
                    $('#dashEquipList').innerHTML = list2.map(e => {
                        const { text, color } = statusMap[e.status] || { text: 'N/A', color: 'bg-gray-100' };
                        const isAdmin = state.user.role === 'admin';
                        const isSelected = state.selectedEquipment.has(e.id);
                        const checkboxHTML = isAdmin ? `<input type="checkbox" onchange="handleEquipCheckboxChange(${e.id}, this.checked)" class="absolute top-3 right-3 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300" ${isSelected ? 'checked' : ''}>` : '';
                        let adminButtons = '';
                        if (isAdmin) {
                           adminButtons = `<div class="mt-2 flex gap-2">
                                <button onclick="handleEditEquipmentClick(${e.id})" class="text-xs text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                ${e.status !== 'deleted' ? `<button onclick="handleDeleteEquipmentClick(${e.id})" class="text-xs text-red-600 hover:underline">‡∏•‡∏ö</button>` : ''}
                            </div>`;
                        }
                        const deletionInfo = e.status === 'deleted' ? `<div class="text-xs text-red-700 bg-red-50 p-1.5 mt-2 rounded-md"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${e.deletion_reason || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏'}</div>` : '';
                        return `<div class="relative rounded-xl border ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-200' : 'border-slate-200'} p-4 bg-white">${checkboxHTML}<div class="font-semibold">${e.name}</div><div class="text-sm text-slate-500">S/N: ${e.serial}</div><div class="text-xs text-slate-400 mt-1">${e.type}</div><span class="mt-2 inline-block text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>${deletionInfo}${adminButtons}</div>`;
                    }).join('') || `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>`;
                    
                    if (forAssessment && $('#assessmentEquipList')) {
                        const t3 = $('#assessmentTypeFilter')?.value || '';
                        const list3 = await api.equipmentList('', '', t3);
                        $('#assessmentEquipList').innerHTML = list3.map(e => `<button onclick="handleAssessmentClick(${e.id}, '${e.name}')" class="text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50"><div class="font-semibold">${e.name}</div><div class="text-sm text-slate-500">S/N: ${e.serial}</div><div class="text-xs text-slate-400 mt-1">${e.type}</div></button>`).join('') || `<p class="text-slate-500 col-span-full">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ</p>`;
                    }
                }
            }
            async function renderSummaries() {
                if (!$('#equipmentSummary')) return;
                const equipSummary = await api.equipmentList();
                const total = equipSummary.length;
                const borrowed = equipSummary.filter(e => e.status === 'borrowed').length;
                const maintenance = equipSummary.filter(e => ['under_maintenance', 'pending_repair_approval'].includes(e.status)).length;
                const available = equipSummary.filter(e => e.status === 'available').length;
                $('#equipmentSummary').innerHTML = `<div class="rounded-xl p-4 bg-blue-100 text-blue-800"><div class="text-sm">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-2xl font-bold mt-1">${total}</div></div><div class="rounded-xl p-4 bg-emerald-100 text-emerald-800"><div class="text-sm">‡∏ß‡πà‡∏≤‡∏á</div><div class="text-2xl font-bold mt-1">${available}</div></div><div class="rounded-xl p-4 bg-indigo-100 text-indigo-800"><div class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="text-2xl font-bold mt-1">${borrowed}</div></div><div class="rounded-xl p-4 bg-amber-100 text-amber-800"><div class="text-sm">‡∏£‡∏≠/‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div><div class="text-2xl font-bold mt-1">${maintenance}</div></div>`;
                const userSummaryContainer = $('#userSummaryContainer');
                if (!state.user || !['admin', 'approver'].includes(state.user.role)) {
                    if (userSummaryContainer) userSummaryContainer.classList.add('hidden');
                } else {
                    if (userSummaryContainer) userSummaryContainer.classList.remove('hidden');
                    const allUsers = await api.listAllUsers();
                    const activeCount = allUsers.filter(u => u.status === 'active').length;
                    const pendingCount = allUsers.filter(u => u.status === 'pending_approval').length;
                    $('#userSummary').innerHTML = `<div class="rounded-xl p-4 bg-green-100 text-green-800"><div class="text-sm">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div><div class="text-2xl font-bold mt-1">${activeCount}</div></div><div class="rounded-xl p-4 bg-yellow-100 text-yellow-800"><div class="text-sm">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="text-2xl font-bold mt-1">${pendingCount}</div></div>`;
                }
            }
             async function renderBorrowHistory() {
                if (!state.user || !$('#myBorrowsHistory')) return;
                 const allMyBorrows = await api.myBorrows(state.user.id);
                 const filter = $('#borrowHistoryFilter .bg-white')?.dataset?.filter || 'all';
                 let historyBorrows = [];
                 if (filter === 'all') { historyBorrows = allMyBorrows; }
                 else if (filter === 'borrowed') { historyBorrows = allMyBorrows.filter(b => ['pending_borrow_approval', 'pending_delivery', 'borrowed'].includes(b.status)); }
                 else if (filter === 'returned') { historyBorrows = allMyBorrows.filter(b => !['pending_borrow_approval', 'pending_delivery', 'borrowed'].includes(b.status)); }
                $('#myBorrowsHistory').innerHTML = historyBorrows.length === 0 ? `<p class="text-slate-500 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>` : historyBorrows.map(b => renderBorrowCard(b)).join('');
            }
            function renderBorrowCard(b) {
                const { text, color } = getBorrowStatusTextAndColor(b.status);
                return `<div class="p-3 rounded-lg border border-slate-200 text-sm">
                    <div class="flex justify-between items-start">
                        <span class="font-semibold">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${b.id} (${b.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>
                    </div>
                    <p class="text-slate-600 mt-1">‡∏¢‡∏∑‡∏°: ${b.borrow_date} | ‡πÇ‡∏î‡∏¢: ${b.user_name}</p>
                    <div class="text-right mt-1">
                        <button onclick="handleViewBorrowDetails(${b.id})" class="text-xs text-indigo-600 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                    </div>
                </div>`;
            }
            async function renderApprovalLists() {
                if (!state.user || !['admin', 'approver'].includes(state.user.role) || !$('#approvalUsers')) return;
                const pendingUsers = await api.listPendingUsers();
                $('#approvalUsers').innerHTML = pendingUsers.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : pendingUsers.map(u => `<div class="p-3 rounded-lg border border-slate-200"><p class="font-semibold">${u.full_name} (${u.agency})</p><div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1"><p><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${u.email}</p><p><strong>‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${u.phone}</p><p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${u.address}</p></div><div class="mt-2 flex gap-2"><button onclick="handleApproveUser(${u.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="handleRejectUser(${u.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div></div>`).join('');
                
                const borrowReqs = await api.listBorrowRequests();
                $('#approvalBorrowList').innerHTML = borrowReqs.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : borrowReqs.map(b => { 
                    const equipments = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)); 
                    return `<div class="p-3 rounded-lg border border-slate-200"><p><span class="font-semibold">${b.user_name}</span> ‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° <span class="font-semibold">${b.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</span></p><div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1"><p class="font-medium text-slate-800">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ:</p><ul class="list-disc list-inside">${equipments.map(e => `<li>${e?.name} (${e?.type}) - S/N: ${e?.serial}</li>`).join('')}</ul><hr class="my-2"><p><strong>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${b.purpose}</p></div><div class="mt-2 flex justify-between items-center"><div class="flex gap-2"><button onclick="handleApproveBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button><button onclick="handleRejectBorrow(${b.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></div><button onclick="handleViewBorrowDetails(${b.id})" class="text-xs text-indigo-600 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div></div>` 
                }).join('');

                const repairReqs = await api.listRepairRequests();
                $('#approvalRepairList').innerHTML = repairReqs.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>` : repairReqs.map(r => `<div class="p-3 rounded-lg border border-slate-200">
                    <p>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏° <span class="font-semibold">${r.equipment_name}</span></p>
                    <div class="text-sm text-slate-600 bg-slate-50 p-2 rounded-md mt-1">
                        <p class="truncate"><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> ${r.damage_description}</p>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <div class="flex gap-2">
                           <button onclick="handleApproveRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-emerald-500 text-white hover:bg-emerald-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                           <button onclick="handleRejectRepair(${r.id})" class="px-3 py-1 text-sm rounded bg-rose-500 text-white hover:bg-rose-600">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        </div>
                        <button onclick="handleViewRepairDetails(${r.id})" class="text-xs text-indigo-600 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
                    </div>
                </div>`).join('');
            }
            function populateApprovalActionFilter() {
                if (!state.user) return;
                const approvalActions = new Set(Object.keys(approvalActionMap));
                const history = state.activityLog.filter(log => log.admin_id === state.user.id && approvalActions.has(log.action));
                const uniqueActions = [...new Set(history.map(log => log.action))];
                
                const select = $('#approvalHistoryActionFilter');
                if (select) {
                    while(select.options.length > 1) { select.remove(1); }
                    uniqueActions.sort().forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        option.textContent = approvalActionMap[action] || action;
                        select.appendChild(option);
                    });
                }
            }
             async function renderApprovalHistory() {
                if (!state.user || !['admin', 'approver'].includes(state.user.role) || !$('#approvalHistoryList')) return;
                
                const approvalActions = new Set(Object.keys(approvalActionMap));
                let history = state.activityLog.filter(log => log.admin_id === state.user.id && approvalActions.has(log.action));

                const actionFilter = $('#approvalHistoryActionFilter').value;
                const startDate = $('#approvalHistoryStartDate').value;
                const endDate = $('#approvalHistoryEndDate').value;
                const sortBy = $('#approvalHistorySort').value;

                if (actionFilter) {
                    history = history.filter(log => log.action === actionFilter);
                }
                if (startDate) {
                    history = history.filter(log => log.timestamp.slice(0, 10) >= startDate);
                }
                if (endDate) {
                    history = history.filter(log => log.timestamp.slice(0, 10) <= endDate);
                }

                history.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortBy === 'oldest' ? dateA - dateB : dateB - dateA;
                });

                const container = $('#approvalHistoryList');
                if (history.length === 0) {
                    container.innerHTML = `<p class="text-slate-500 text-center py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>`;
                    return;
                }
                
                container.innerHTML = history.map(log => {
                    const action = log.action.toLowerCase();
                    const isApprove = action.includes('approve');
                    const isReject = action.includes('reject');

                    let icon;
                    if (isApprove) {
                        icon = `<span class="h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 font-bold text-lg">‚úì</span>`;
                    } else if (isReject) {
                        icon = `<span class="h-8 w-8 rounded-full bg-red-100 flex items-center justify-center text-red-600 font-bold text-lg">‚úó</span>`;
                    } else {
                        icon = `<span class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-lg">-</span>`;
                    }

                    return `<div class="flex items-center gap-3 p-2.5 border-b border-slate-100 cursor-pointer hover:bg-slate-50" onclick="handleViewApprovalLogDetails(${log.id})">
                        ${icon}
                        <div class="flex-grow">
                            <p class="font-medium text-sm text-slate-800">${log.details}</p>
                            <p class="text-xs text-slate-500">${new Date(log.timestamp).toLocaleString('th-TH')}</p>
                        </div>
                        <span class="text-xs text-slate-400">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                    </div>`;
                }).join('');
            }
            async function renderTechnicianQueues() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#techReturnQueue')) return;
                
                const returnQueue = await api.queueForReturn();
                $('#techReturnQueue').innerHTML = returnQueue.length === 0 ? `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û</p>` : returnQueue.map(b => { 
                    const isLate = new Date() > new Date(b.due_date); 
                    const equipDetails = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)).map(e => `<li>${e.name} (${e.type})</li>`).join('');
                    return `<div class="p-3 rounded-lg border ${isLate ? 'border-red-300 bg-red-50' : 'border-slate-200'} text-sm"><p><span class="font-semibold">${b.user_name}</span> ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p><ul class="text-slate-600 list-disc list-inside">${equipDetails}</ul><p class="text-slate-600">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô: ${b.due_date}</p>${isLate ? `<p class="text-xs font-semibold text-red-600">‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤!</p>` : ''}<button onclick="handleReturnClick(${b.id})" class="mt-2 w-full px-3 py-1 rounded bg-orange-500 text-white hover:bg-orange-600 text-xs">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button></div>` 
                }).join('');

                const repairs = await api.listRepairs();
                $('#repairList').innerHTML = repairs.filter(r => r.status !== 'completed').length === 0 ? `<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>` : repairs.filter(r => r.status !== 'completed').map(r => renderRepairCard(r)).join('');
            }
             async function renderRepairHistory() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#allRepairsHistory')) return;
                const repairs = await api.listRepairs();
                $('#allRepairsHistory').innerHTML = repairs.length === 0 ? `<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</div>` : repairs.map(r => renderRepairCard(r, true)).join('');
            }
            function renderRepairCard(r, isHistory = false) {
                const { text, color } = getRepairStatusTextAndColor(r.status);
                const canComplete = r.status === 'repair_approved' && (state.user.role === 'technician' || state.user.role === 'admin');
                const adminDelete = isHistory && state.user.role === 'admin' ? `<button class="text-xs text-red-500 hover:underline" onclick="handleDeleteRepair(${r.id})">‡∏•‡∏ö</button>` : '';
                
                return `<div class="p-3 rounded-lg border border-slate-200 text-sm">
                    <div class="flex justify-between items-start">
                        <span class="font-semibold">${r.equipment_name}</span>
                        <span class="text-xs font-medium px-2 py-1 rounded-full ${color}">${text}</span>
                    </div>
                    <p class="text-slate-600 truncate">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ${r.damage_description}</p>
                    <p class="text-xs text-slate-500">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${r.request_date}</p>
                    <div class="mt-2 flex justify-between items-center">
                        <div>
                            ${canComplete ? `<button onclick="handleCompleteRepairClick(${r.id})" class="px-3 py-1 text-xs rounded bg-indigo-500 text-white hover:bg-indigo-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>` : ''}
                        </div>
                        <div class="flex gap-3 items-center">
                            ${adminDelete}
                            <button onclick="handleViewRepairDetails(${r.id})" class="text-xs text-indigo-600 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                        </div>
                    </div>
                </div>`;
            }
            async function renderDeliveryTab() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#deliveryQueueTableBody')) return;
                
                const deliveryQueue = await api.queueForDelivery();
                const tableBody = $('#deliveryQueueTableBody');
                
                if (deliveryQueue.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</td></tr>`;
                    return;
                }
                
                tableBody.innerHTML = deliveryQueue.map(b => {
                    const equipDetails = b.equipment_ids.map(id => state.equipment.find(e => e.id === id))
                                                        .map(e => e ? `<li>${e.name} (S/N: ${e.serial})</li>` : '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>').join('');
                    return `<tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-4 py-2 font-medium text-slate-900">#${b.id}</td>
                        <td class="px-4 py-2">${b.user_name}</td>
                        <td class="px-4 py-2"><ul class="list-disc list-inside text-xs">${equipDetails}</ul></td>
                        <td class="px-4 py-2">
                            <div class="flex flex-col gap-1.5">
                                <button onclick="handleConfirmDelivery(${b.id})" class="px-3 py-1.5 text-xs rounded-lg bg-blue-500 text-white hover:bg-blue-600">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</button>
                                <button onclick="handlePreDeliveryCheck(${b.id})" class="px-3 py-1.5 text-xs rounded-lg bg-slate-200 text-slate-700 hover:bg-slate-300">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            }
            let borrowChartInstance = null;
            let repairCostChartInstance = null;
            let borrowByTypeChartInstance = null;
            async function renderReports() {
                if (!state.user || !['admin', 'approver', 'technician'].includes(state.user.role) || !$('#reportCards')) return;
                
                const filterMonth = $('#reportMonthFilter').value;
                const reportData = await api.getReportData(filterMonth);
                const equipSummary = await api.equipmentList();
                const totalEquip = equipSummary.filter(e => e.status !== 'deleted').length;

                $('#reportCards').innerHTML = `<div class="rounded-xl p-4 bg-blue-100 text-blue-800"><div class="text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="text-3xl font-bold mt-1">${totalEquip}</div></div><div class="rounded-xl p-4 bg-indigo-100 text-indigo-800"><div class="text-sm">‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div><div class="text-3xl font-bold mt-1">${reportData.totalBorrows}</div></div><div class="rounded-xl p-4 bg-amber-100 text-amber-800"><div class="text-sm">‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div><div class="text-3xl font-bold mt-1">${reportData.totalRepairs}</div></div><div class="rounded-xl p-4 bg-red-100 text-red-800"><div class="text-sm">‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</div><div class="text-3xl font-bold mt-1">${reportData.totalRepairCost.toLocaleString()}.-</div></div>`;
                
                const borrowsToChart = filterMonth ? state.borrows.filter(b => b.borrow_date.startsWith(filterMonth)) : state.borrows;
                const repairsToChart = filterMonth ? state.repairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : state.repairs;

                const dailyBorrows = borrowsToChart.reduce((acc, b) => { const day = b.borrow_date; acc[day] = (acc[day] || 0) + 1; return acc; }, {});
                const dailyRepairCosts = repairsToChart.reduce((acc, r) => { const day = r.request_date; acc[day] = (acc[day] || 0) + (Number(r.cost) || 0); return acc; }, {});

                if (borrowChartInstance) borrowChartInstance.destroy();
                borrowChartInstance = new Chart($('#borrowChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: Object.keys(dailyBorrows), datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', data: Object.values(dailyBorrows), backgroundColor: 'rgba(79, 70, 229, 0.7)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });

                if (repairCostChartInstance) repairCostChartInstance.destroy();
                repairCostChartInstance = new Chart($('#repairCostChart').getContext('2d'), {
                    type: 'line',
                    data: { labels: Object.keys(dailyRepairCosts), datasets: [{ label: '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏° (‡∏ö‡∏≤‡∏ó)', data: Object.values(dailyRepairCosts), backgroundColor: 'rgba(217, 70, 239, 0.2)', borderColor: 'rgba(217, 70, 239, 1)', fill: true, tension: 0.1 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' } }, scales: { y: { beginAtZero: true } } }
                });
                
                // New Analytics Rendering
                const mostRepairedList = $('#mostRepairedList');
                if (reportData.mostRepairedEquipment.length > 0) {
                    mostRepairedList.innerHTML = `<ol class="list-decimal list-inside space-y-1 text-slate-700">${reportData.mostRepairedEquipment.map(e => `<li>${e.name} <span class="text-slate-500">(S/N: ${e.serial}, ${e.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span></li>`).join('')}</ol>`;
                } else {
                    mostRepairedList.innerHTML = `<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</p>`;
                }
                
                if (borrowByTypeChartInstance) borrowByTypeChartInstance.destroy();
                borrowByTypeChartInstance = new Chart($('#borrowByTypeChart').getContext('2d'), {
                    type: 'pie',
                    data: { 
                        labels: Object.keys(reportData.borrowingByType), 
                        datasets: [{ 
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', 
                            data: Object.values(reportData.borrowingByType),
                            backgroundColor: ['#4f46e5', '#7c3aed', '#0ea5e9', '#f59e0b', '#10b981', '#ef4444']
                        }] 
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' } } }
                });
                
                // Technician Section
                const techSection = $('#technicianReportSection');
                if (['admin', 'technician'].includes(state.user.role)) {
                    techSection.classList.remove('hidden');
                    $('#techReportCards').innerHTML = `<div class="rounded-xl p-4 bg-sky-100 text-sky-800"><div class="text-sm">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div><div class="text-3xl font-bold mt-1">${reportData.averageRepairTime.toFixed(1)} <span class="text-lg">‡∏ß‡∏±‡∏ô</span></div></div><div class="rounded-xl p-4 bg-orange-100 text-orange-800"><div class="text-sm">‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà</div><div class="text-3xl font-bold mt-1">${reportData.pendingRepairsCount} <span class="text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div></div>`;
                    
                    const frequentPartsList = $('#frequentPartsList');
                    if(reportData.frequentlyUsedParts.length > 0) {
                        frequentPartsList.innerHTML = `<ol class="list-decimal list-inside space-y-1 text-slate-700">${reportData.frequentlyUsedParts.map(([part, count]) => `<li class="capitalize">${part} <span class="text-slate-500">(${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span></li>`).join('')}</ol>`;
                    } else {
                        frequentPartsList.innerHTML = `<p class="text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</p>`;
                    }
                } else {
                    techSection.classList.add('hidden');
                }
            }
            async function renderAdminTab() {
                if (!state.user || state.user.role !== 'admin' || !$('#adminTab')) return;
                
                // Populate role filter if not already populated
                const roleFilter = $('#adminUserRoleFilter');
                if (roleFilter && roleFilter.options.length === 1) {
                    roleFilter.innerHTML += Object.keys(roleMap).map(r => `<option value="${r}">${roleMap[r]}</option>`).join('');
                }

                // User Management List
                const q = $('#adminUserSearch').value.toLowerCase();
                const role = $('#adminUserRoleFilter').value;
                const status = $('#adminUserStatusFilter').value;
                const allUsers = await api.listAllUsers();
                const filteredUsers = allUsers.filter(u => 
                    (q === '' || u.full_name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)) &&
                    (role === '' || u.role === role) &&
                    (status === '' || u.status === status)
                );

                $('#adminUserList').innerHTML = filteredUsers.map(u => {
                    const statusColors = { active: 'bg-green-100 text-green-800', pending_approval: 'bg-yellow-100 text-yellow-800', deleted: 'bg-slate-200 text-slate-600' };
                    const statusText = { active: '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', pending_approval: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', deleted: '‡∏ñ‡∏π‡∏Å‡∏•‡∏ö' };
                    return `<tr class="bg-white border-b">
                        <td class="px-4 py-2 font-medium text-slate-900">${u.full_name}</td>
                        <td class="px-4 py-2">${roleMap[u.role]}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[u.status] || ''}">${statusText[u.status] || u.status}</span></td>
                        <td class="px-4 py-2">${u.email}</td>
                        <td class="px-4 py-2">
                           <button onclick="handleEditUserClick(${u.id})" class="text-xs text-blue-600 hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                           <button onclick="handleDeleteUserClick(${u.id})" class="text-xs text-red-600 hover:underline ml-2">‡∏•‡∏ö</button>
                        </td>
                    </tr>`;
                }).join('') || `<tr><td colspan="5" class="text-center p-4 text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</td></tr>`;
                
                // Activity Log
                const logQ = $('#adminLogSearch').value.toLowerCase();
                const filteredLogs = state.activityLog.filter(log => logQ === '' || log.details.toLowerCase().includes(logQ) || log.admin_name.toLowerCase().includes(logQ) || log.action.toLowerCase().includes(logQ));
                $('#adminActivityLog').innerHTML = filteredLogs.map(log => {
                    return `<tr class="bg-white border-b hover:bg-slate-50">
                        <td class="px-4 py-2 text-slate-500 whitespace-nowrap">${new Date(log.timestamp).toLocaleString('th-TH')}</td>
                        <td class="px-4 py-2 font-medium">${log.admin_name}</td>
                        <td class="px-4 py-2 capitalize">${log.action.replace(/_/g, ' ').toLowerCase()}</td>
                        <td class="px-4 py-2">${log.details}</td>
                    </tr>`;
                }).join('') || `<tr><td colspan="4" class="text-center p-4 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</td></tr>`;
            }
            async function renderAssessmentHistory() {
                if (!state.user || !['admin', 'technician'].includes(state.user.role) || !$('#assessmentHistoryList')) return;
                const assessments = await api.listAssessments();
                const container = $('#assessmentHistoryList');
                if (assessments.length === 0) {
                    container.innerHTML = `<p class="text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>`;
                    return;
                }
                container.innerHTML = assessments.map(a => {
                    const equip = state.equipment.find(e => e.id === a.equipment_id);
                    return `<div class="p-3 rounded-lg border border-slate-200 text-sm">
                        <div class="flex justify-between items-start">
                            <span class="font-semibold">${equip?.name || 'N/A'} <span class="text-slate-500 font-normal">(S/N: ${equip?.serial || 'N/A'})</span></span>
                            <span class="text-xs text-slate-500">${a.date}</span>
                        </div>
                        <p class="text-slate-600 mt-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•: ${a.result_flow_rate || 'N/A'} ‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: ${a.result_temp || 'N/A'} ¬∞C</p>
                        <button onclick="handleViewAssessmentDetails(${a.id})" class="mt-2 text-xs text-indigo-600 hover:underline">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°</button>
                    </div>`;
                }).join('');
            }
            function renderNotifications() {
                const notificationBtn = $('#notificationBtn');
                const notificationList = $('#notificationList');
                if (!state.user || !notificationList) return;
                const userNotifications = state.notifications.filter(n => (Array.isArray(n.target) && (n.target.includes(state.user.role) || n.target.includes(state.user.id))));
                if (userNotifications.length === 0) {
                    notificationList.innerHTML = `<p class="p-4 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>`;
                } else {
                    notificationList.innerHTML = userNotifications.map(n => {
                        const readClass = n.read ? '' : 'bg-indigo-50';
                        const dotHTML = n.read ? '<div class="w-2 h-2"></div>' : '<div class="w-2 h-2 rounded-full bg-blue-500"></div>';
                        return `<div class="p-2 flex items-start gap-3 border-b border-slate-100 last:border-b-0 hover:bg-slate-50 cursor-pointer ${readClass}">
                                    <div class="pt-1.5">${dotHTML}</div>
                                    <div>
                                        <p class="text-slate-800">${n.message}</p>
                                        <p class="text-xs text-slate-500 mt-0.5">${formatTimeAgo(n.timestamp)}</p>
                                    </div>
                                </div>`;
                    }).join('');
                }
                const hasUnread = userNotifications.some(n => !n.read);
                notificationBtn.classList.toggle('notification-dot', hasUnread);
            }

            window.handleApproveUser = async (id) => { try { await api.approveUser(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectUser = async (id) => { try { await api.rejectUser(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleApproveBorrow = async (id) => { try { await api.approveBorrow(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à)'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectBorrow = async (id) => { try { await api.rejectBorrow(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleAdminCancelBorrow = async (id) => { if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { try { await api.adminCancelBorrow(id); toast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } } };
            window.handleApproveRepair = async (id) => { try { await api.approveRepair(id); toast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleRejectRepair = async (id) => { try { await api.rejectRepair(id); toast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); fullRender(); } catch (e) { toast(e.message, true); } };
            window.handleDeleteRepair = async (id) => { if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { state.repairs = state.repairs.filter(r => r.id !== id); toast('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); fullRender(); }};
            window.showImageModal = (repairId, attachmentIndex) => {
                const repair = state.repairs.find(r => r.id === repairId);
                if (repair && repair.attachments[attachmentIndex]) {
                    const base64Image = repair.attachments[attachmentIndex];
                    const content = `<img src="${base64Image}" class="max-w-full max-h-[80vh] mx-auto rounded-lg">`;
                    showModal('‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', content, '');
                }
            };
             window.handleConfirmDelivery = async (borrowId) => {
                if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏° #${borrowId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏õ‡∏Å‡∏ï‡∏¥)`)) {
                    try {
                        await api.performPreDeliveryCheck(borrowId, [], {}); 
                        toast('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        fullRender();
                    } catch(e) {
                        toast(e.message, true);
                    }
                }
            };
            
            function getBorrowDetailsHTML(borrow) {
                if (!borrow) return '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>';
                const equipments = borrow.equipment_ids.map(id => state.equipment.find(e => e.id === id));
                const user = state.users.find(u => u.id === borrow.user_id);
                const { text: statusText } = getBorrowStatusTextAndColor(borrow.status);

                return `
                    <div class="prose prose-sm max-w-none">
                        <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° #${borrow.id}</h3>
                        <p><strong>‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°:</strong> ${borrow.user_name || user?.full_name || 'N/A'}</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${statusText}</p>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h4>
                        <ul>
                            <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°:</strong> ${borrow.borrow_date}</li>
                            <li><strong>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô:</strong> ${borrow.due_date}</li>
                            <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏à‡∏£‡∏¥‡∏á:</strong> ${borrow.actual_return_date || '-'}</li>
                            ${borrow.late_return_reason ? `<li><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏ä‡πâ‡∏≤:</strong> ${borrow.late_return_reason}</li>` : ''}
                        </ul>
                        <h4>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô</h4>
                        <ul>
                            <li><strong>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${borrow.purpose}</li>
                            <li><strong>‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô:</strong> ${borrow.contact_name} (${borrow.contact_phone})</li>
                            <li><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${borrow.notes || '-'}</li>
                        </ul>
                        <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
                        <ul>${equipments.map(e => `<li>${e?.name || 'N/A'} (S/N: ${e?.serial || 'N/A'})</li>`).join('')}</ul>
                    </div>
                `;
            }
            function getRepairDetailsHTML(repair) {
                if (!repair) return '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</p>';
                const equip = state.equipment.find(e => e.id === repair.equipment_id);
                const tech = state.users.find(u => u.id === repair.technician_id);
                const { text: statusText } = getRepairStatusTextAndColor(repair.status);

                const attachmentsHTML = (repair.attachments && repair.attachments.length > 0)
                    ? `<h4>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</h4><div class="flex flex-wrap gap-2 mt-1">
                        ${repair.attachments.map((att, index) => {
                            if (att.startsWith('data:image/')) {
                                return `<img src="${att}" onclick="showImageModal(${repair.id}, ${index})" class="h-20 w-20 object-cover rounded-md cursor-pointer hover:opacity-80">`;
                            } else {
                                return `<a href="${att}" target="_blank" class="h-20 w-20 rounded-md bg-slate-100 flex items-center justify-center text-red-500 text-sm p-1 text-center font-semibold hover:bg-slate-200">PDF</a>`;
                            }
                        }).join('')}
                       </div>`
                    : '';
                
                return `
                    <div class="prose prose-sm max-w-none">
                        <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° #${repair.id}</h3>
                        <p><strong>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</strong> ${repair.equipment_name} (S/N: ${equip?.serial || 'N/A'})</p>
                        <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${statusText}</p>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h4>
                        <ul>
                            <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${repair.request_date}</li>
                            <li><strong>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${repair.damage_description}</li>
                        </ul>
                        <h4>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h4>
                        <ul>
                            <li><strong>‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°:</strong> ${repair.repair_by || tech?.full_name || '-'}</li>
                            <li><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à:</strong> ${repair.repair_date || '-'}</li>
                            <li><strong>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</strong> ${repair.repair_details || '-'}</li>
                            <li><strong>‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà:</strong> ${repair.parts_used || '-'}</li>
                            <li><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</strong> ${repair.cost ? `${Number(repair.cost).toLocaleString()} ‡∏ö‡∏≤‡∏ó` : '-'}</li>
                        </ul>
                        ${attachmentsHTML}
                    </div>
                `;
            }
            function getUserDetailsHTML(user) {
                if (!user) return '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
                return `
                    <div class="prose prose-sm max-w-none">
                        <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.full_name}</h3>
                        <ul>
                            <li><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> ${user.email}</li>
                            <li><strong>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:</strong> ${roleMap[user.role] || '-'}</li>
                            <li><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${user.status}</li>
                            <li><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${user.agency || '-'}</li>
                            <li><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong> ${user.phone || '-'}</li>
                            <li><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${user.address || '-'}</li>
                        </ul>
                    </div>
                `;
            }

            window.handleViewBorrowDetails = (id) => {
                const borrow = state.borrows.find(b => b.id === id);
                showModal(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° #${id}`, getBorrowDetailsHTML(borrow), '');
            };
            window.handleViewRepairDetails = (id) => {
                const repair = state.repairs.find(r => r.id === id);
                showModal(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° #${id}`, getRepairDetailsHTML(repair), '');
            };
            window.handleViewApprovalLogDetails = (logId) => {
                const log = state.activityLog.find(l => l.id === logId);
                if (!log) { toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', true); return; }

                let title = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
                let content = '';

                switch (log.target_type) {
                    case 'user':
                        const user = [...state.users, ...state.pendingUsers].find(u => u.id === log.target_id);
                        title = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ #${log.target_id}`;
                        content = getUserDetailsHTML(user);
                        break;
                    case 'borrow':
                        const borrow = state.borrows.find(b => b.id === log.target_id);
                        title = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° #${log.target_id}`;
                        content = getBorrowDetailsHTML(borrow);
                        break;
                    case 'repair':
                        const repair = state.repairs.find(r => r.id === log.target_id);
                        title = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° #${log.target_id}`;
                        content = getRepairDetailsHTML(repair);
                        break;
                    default:
                        content = `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</p>`;
                }
                showModal(title, content, '');
            };

            function getChecklistHTML(formId, checklist, equipment) {
                return equipment.map(equip => `
                    <div class="mt-4 border-t pt-3">
                         <p class="font-semibold text-sm mb-2">${equip.name} (S/N: ${equip.serial})</p>
                         ${checklist.map(item => `
                            <div class="grid grid-cols-3 items-center border-b py-2">
                                <label for="${formId}-${equip.id}-${item.id}" class="text-sm text-slate-700 col-span-2">${item.label}</label>
                                <div class="flex items-center justify-end gap-4">
                                     <label class="flex items-center gap-1"><input type="radio" data-equip-id="${equip.id}" name="${item.id}-${equip.id}" value="ok" class="h-4 w-4" checked> <span class="text-sm">‡∏õ‡∏Å‡∏ï‡∏¥</span></label>
                                     <label class="flex items-center gap-1"><input type="radio" data-equip-id="${equip.id}" name="${item.id}-${equip.id}" value="faulty" class="h-4 w-4"> <span class="text-sm">‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span></label>
                                </div>
                            </div>`).join('')}
                    </div>
                `).join('');
            }
            window.handlePreDeliveryCheck = (borrowId) => {
                const borrow = state.borrows.find(b => b.id === borrowId);
                const equipmentInBorrow = borrow.equipment_ids.map(id => state.equipment.find(e => e.id === id));
                const inspectionChecklist = [
                    { id: 'check_exterior', label: '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' }, { id: 'check_fuel_tank', label: '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á' },
                    { id: 'check_carburetor', label: '3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { id: 'check_spark_plug', label: '4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô' },
                    { id: 'check_battery', label: '5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà' }, { id: 'check_chem_pipe', label: '6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ' },
                    { id: 'check_nozzle_system', label: '7. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô' }
                ];
                const content = `
                <form id="preDeliveryForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${borrow.equipment_ids.length} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö <strong>${borrow.user_name}</strong></p>
                    <div class="bg-slate-50 p-3 rounded-lg max-h-80 overflow-y-auto">${getChecklistHTML('preDeliveryForm', inspectionChecklist, equipmentInBorrow)}</div>
                     <textarea name="notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="mt-3 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                </form>`;
                const actions = `<button type="button" id="reportFaultBtn" class="px-4 py-2 rounded-lg bg-amber-500 text-white hover:bg-amber-600">‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
                                 <button type="submit" id="confirmDeliveryBtn" form="preDeliveryForm" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö (‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥)</button>`;
                showModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', content, actions);
                
                const form = $('#preDeliveryForm');
                $('#reportFaultBtn').addEventListener('click', () => {
                     const faultyRadios = form.querySelectorAll('input[value="faulty"]:checked');
                     const faultyItems = [...new Set(Array.from(faultyRadios).map(r => parseInt(r.dataset.equipId)))].map(id => state.equipment.find(e => e.id === id));
                     if(faultyItems.length > 0) {
                        handleReportFault(borrowId, faultyItems);
                     } else {
                        toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà "‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" ‡∏Å‡πà‡∏≠‡∏ô', true);
                     }
                });
            };

            window.handleReportFault = (borrowId, faultyItems) => {
                const content = `
                <form id="replaceEquipForm" data-id="${borrowId}">
                    <p class="text-sm text-slate-600 mb-3">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡πÅ‡∏ó‡∏ô</p>
                    <div class="space-y-4">
                    ${faultyItems.map(item => {
                        const availableReplacements = state.equipment.filter(e => e.status === 'available' && e.type === item.type);
                        return `
                        <div class="p-2 border rounded-md">
                             <p class="font-medium text-sm">‡πÄ‡∏™‡∏µ‡∏¢: ${item.name} <span class="text-slate-500">(${item.type})</span></p>
                             <select name="replacement_${item.id}" class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-300" required>
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô --</option>
                                ${availableReplacements.map(e => `<option value="${e.id}">${e.name} (S/N: ${e.serial})</option>`).join('')}
                             </select>
                        </div>
                        `;
                    }).join('')}
                    </div>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                 <button type="submit" form="replaceEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>`;
                showModal('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô', content, actions);
            };

            window.handleReturnClick = (id) => {
                const borrow = state.borrows.find(b => b.id === id);
                const equipmentInBorrow = borrow.equipment_ids.map(id => state.equipment.find(e => e.id === id));
                const isLate = new Date() > new Date(borrow.due_date);
                const lateReasonHTML = isLate ? `<label class="block text-sm font-medium text-slate-700 mt-4">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</label><textarea name="late_return_reason" rows="2" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="mt-1 w-full px-3 py-2 rounded-lg border border-red-300" required></textarea>` : '';
                const inspectionChecklist = [{ id: 'check_exterior', label: '1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' }, { id: 'check_fuel_tank', label: '2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ñ‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á' }, { id: 'check_carburetor', label: '3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏π‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå' }, { id: 'check_spark_plug', label: '4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô' }, { id: 'check_battery', label: '5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà' }, { id: 'check_chem_pipe', label: '6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÄ‡∏Ñ‡∏°‡∏µ' }, { id: 'check_nozzle_system', label: '7. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡πà‡∏ô' }];
                const content = `<form id="postReturnForm" data-id="${id}">
                    <div class="bg-slate-50 p-3 rounded-lg max-h-60 overflow-y-auto">${getChecklistHTML('postReturnForm', inspectionChecklist, equipmentInBorrow)}</div>
                    <label class="block text-sm font-medium text-slate-700 mt-4">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label>
                    <select name="isDamaged" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                        <option value="false">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                        <option value="true">‡∏ä‡∏≥‡∏£‡∏∏‡∏î (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</option>
                    </select>
                    <textarea name="notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏´‡∏≤‡∏Å‡∏ä‡∏≥‡∏£‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£)" class="mt-2 w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                    <div id="attachmentsContainer" class="hidden mt-2">
                        <label class="block text-sm font-medium text-slate-700">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∏‡∏î</label>
                        <input type="file" name="attachments" multiple accept="image/*" class="mt-1 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        <div id="attachmentPreviews" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                    ${lateReasonHTML}
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="postReturnForm" class="px-4 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</button>`;
                showModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô', content, actions);

                const form = $('#postReturnForm');
                const isDamagedSelect = form.querySelector('select[name="isDamaged"]');
                const attachmentsContainer = form.querySelector('#attachmentsContainer');

                const toggleAttachments = () => {
                    attachmentsContainer.classList.toggle('hidden', isDamagedSelect.value !== 'true');
                };

                isDamagedSelect.addEventListener('change', toggleAttachments);

                form.addEventListener('change', (e) => {
                    if (e.target.type === 'radio') {
                        const isAnyFaulty = form.querySelectorAll('input[value="faulty"]:checked').length > 0;
                        isDamagedSelect.value = isAnyFaulty ? 'true' : 'false';
                        toggleAttachments();
                    }
                });

                const fileInput = form.querySelector('input[name="attachments"]');
                fileInput.addEventListener('change', () => {
                    const previewsContainer = $('#attachmentPreviews');
                    previewsContainer.innerHTML = '';
                    if (fileInput.files.length > 0) {
                        Array.from(fileInput.files).forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.className = 'h-16 w-16 object-cover rounded-md';
                                previewsContainer.appendChild(img);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
            };
            window.handleCompleteRepairClick = (id) => {
                const repair = state.repairs.find(r => r.id === id);
                const content = `<form id="completeRepairForm" data-id="${id}" class="space-y-3 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input name="repair_date" type="date" value="${new Date().toISOString().slice(0, 10)}" required class="w-full px-3 py-2 rounded-lg border border-slate-200">
                        <input name="repair_by" required placeholder="‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°" value="${state.user.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    </div>
                    <div><label class="font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</label><p class="p-2 bg-slate-50 rounded-md">${repair.damage_description}</p></div>
                    <textarea name="repair_details" required rows="3" placeholder="‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                    <textarea name="parts_used" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" class="w-full px-3 py-2 rounded-lg border border-slate-200"></textarea>
                    <input name="cost" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <div id="attachmentsContainer" class="mt-2">
                        <label class="block text-sm font-medium text-slate-700">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)</label>
                        <input type="file" name="attachments" multiple accept="image/*,application/pdf" class="mt-1 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                        <div id="attachmentPreviews" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="completeRepairForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</button>`;
                showModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', content, actions);

                const fileInput = $('#completeRepairForm input[name="attachments"]');
                fileInput.addEventListener('change', () => {
                    const previewsContainer = $('#attachmentPreviews');
                    previewsContainer.innerHTML = '';
                    if (fileInput.files.length > 0) {
                        Array.from(fileInput.files).forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if(file.type.startsWith('image/')) {
                                     const img = document.createElement('img');
                                     img.src = e.target.result;
                                     img.className = 'h-16 w-16 object-cover rounded-md';
                                     previewsContainer.appendChild(img);
                                } else {
                                     const pdfIcon = document.createElement('div');
                                     pdfIcon.className = 'h-16 w-16 rounded-md bg-slate-100 flex items-center justify-center text-xs p-1 text-center';
                                     pdfIcon.textContent = file.name;
                                     previewsContainer.appendChild(pdfIcon);
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
            };
            window.handleAssessmentClick = (id, name) => {
                const equip = state.equipment.find(e => e.id === id);
                const content = `<form id="assessmentForm" data-id="${id}" class="text-sm"><p class="text-base text-slate-600 mb-3">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <strong>${name} (S/N: ${equip.serial})</strong></p><div class="grid md:grid-cols-2 gap-x-6 gap-y-3"><div><label class="font-medium">‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</label><div class="flex gap-4 mt-1"><label><input type="radio" name="exterior_condition" value="new"> ‡πÉ‡∏´‡∏°‡πà</label><label><input type="radio" name="exterior_condition" value="mid" checked> ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</label><label><input type="radio" name="exterior_condition" value="old"> ‡πÄ‡∏Å‡πà‡∏≤</label></div></div><div><label class="font-medium">‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå</label><div class="flex gap-4 mt-1"><label><input type="radio" name="engine_start" value="easy" checked> ‡∏ï‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢</label><label><input type="radio" name="engine_start" value="hard"> ‡∏ï‡∏¥‡∏î‡∏¢‡∏≤‡∏Å</label></div></div><div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-4 gap-3 bg-slate-50 p-2 rounded-md"><label class="font-medium col-span-full">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</label><label><input type="checkbox" name="clean_pipe"> ‡∏ó‡πà‡∏≠‡∏û‡πà‡∏ô</label> <label><input type="checkbox" name="clean_chem_line"> ‡∏™‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏¢‡∏≤</label><label><input type="checkbox" name="clean_gas_tank"> ‡∏ñ‡∏±‡∏á‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô</label> <label><input type="checkbox" name="clean_chem_tank"> ‡∏ñ‡∏±‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ</label></div><div class="md:col-span-2"><h4 class="font-semibold mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h4><div class="grid sm:grid-cols-3 gap-3 mt-1"><input name="chem_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" class="w-full px-3 py-2 rounded-lg border"><input name="chem_concentration" placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô (%)" class="w-full px-3 py-2 rounded-lg border"><input name="chem_mix_ratio" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°" class="w-full px-3 py-2 rounded-lg border"></div></div><div class="md:col-span-2"><h4 class="font-semibold mt-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h4><div class="grid sm:grid-cols-2 gap-3 mt-1"><input name="result_temp" placeholder="‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡πà‡∏≠ (¬∞C)" class="w-full px-3 py-2 rounded-lg border"><input name="result_flow_rate" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ)" class="w-full px-3 py-2 rounded-lg border"></div></div><textarea name="notes" placeholder="‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞" rows="2" class="w-full px-3 py-2 rounded-lg border md:col-span-2"></textarea></div></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="assessmentForm" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>`;
                showModal('‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡πà‡∏ô', content, actions);
            };
             window.handleViewAssessmentDetails = (id) => {
                const assessment = state.assessments.find(a => a.id === id);
                if (!assessment) return;
                const equip = state.equipment.find(e => e.id === assessment.equipment_id);
                const content = `
                    <div class="prose prose-sm max-w-none">
                        <h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${equip?.name || 'N/A'}</h3>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> ${assessment.date}</p>
                        <h4>‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h4>
                        <ul>
                            <li><strong>‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å:</strong> ${assessment.exterior_condition || '-'}</li>
                            <li><strong>‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå:</strong> ${assessment.engine_start || '-'}</li>
                            <li><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î:</strong>
                                <ul>
                                    ${assessment.clean_pipe ? '<li>‡∏ó‡πà‡∏≠‡∏û‡πà‡∏ô</li>' : ''}
                                    ${assessment.clean_chem_line ? '<li>‡∏™‡∏≤‡∏¢‡∏™‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏¢‡∏≤</li>' : ''}
                                    ${assessment.clean_gas_tank ? '<li>‡∏ñ‡∏±‡∏á‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô</li>' : ''}
                                    ${assessment.clean_chem_tank ? '<li>‡∏ñ‡∏±‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ</li>' : ''}
                                </ul>
                            </li>
                        </ul>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h4>
                        <ul>
                            <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</strong> ${assessment.chem_name || '-'}</li>
                            <li><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô:</strong> ${assessment.chem_concentration || '-'}</li>
                            <li><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°:</strong> ${assessment.chem_mix_ratio || '-'}</li>
                        </ul>
                         <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h4>
                        <ul>
                            <li><strong>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡πà‡∏≠:</strong> ${assessment.result_temp || '-'} ¬∞C</li>
                            <li><strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${assessment.result_flow_rate || '-'} ‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ</li>
                        </ul>
                        <p><strong>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</strong> ${assessment.notes || '-'}</p>
                    </div>`;
                showModal('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', content, '');
            };
            const getEquipRowHTML = (rowIndex) => `
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center equip-row border-t py-2">
                    <input name="name_${rowIndex}" required placeholder="‡∏ä‡∏∑‡πà‡∏≠/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠" class="w-full px-2 py-1.5 text-sm rounded-md border border-slate-300">
                    <input name="serial_${rowIndex}" required placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏£‡∏´‡∏±‡∏™" class="w-full px-2 py-1.5 text-sm rounded-md border border-slate-300">
                    <input name="type_${rowIndex}" required placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" class="w-full px-2 py-1.5 text-sm rounded-md border border-slate-300">
                    <input name="price_${rowIndex}" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full px-2 py-1.5 text-sm rounded-md border border-slate-300">
                    <button type="button" class="remove-row-btn text-red-500 hover:bg-red-100 rounded-full h-7 w-7 flex items-center justify-center font-bold">√ó</button>
                </div>
            `;
            window.handleBulkAddEquipmentClick = () => {
                const content = `
                <form id="bulkAddEquipForm">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-2 text-xs font-semibold text-slate-600 px-2">
                        <span>‡∏ä‡∏∑‡πà‡∏≠/‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠</span><span>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏£‡∏´‡∏±‡∏™</span><span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</span><span></span>
                    </div>
                    <div id="bulkAddEquipRows" class="max-h-80 overflow-y-auto">${getEquipRowHTML(0)}</div>
                    <button type="button" id="addEquipRowBtn" class="mt-3 text-sm text-indigo-600 hover:underline">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</button>
                </form>
                `;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="bulkAddEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;
                showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', content, actions);

                let rowIndex = 1;
                const rowsContainer = $('#bulkAddEquipRows');
                $('#addEquipRowBtn').addEventListener('click', () => {
                    const newRow = document.createElement('div');
                    newRow.innerHTML = getEquipRowHTML(rowIndex);
                    rowsContainer.appendChild(newRow.firstElementChild);
                    rowIndex++;
                });

                rowsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-row-btn')) {
                        if (rowsContainer.querySelectorAll('.equip-row').length > 1) {
                            e.target.closest('.equip-row').remove();
                        } else {
                            toast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', true);
                        }
                    }
                });
            };
            window.handleEditEquipmentClick = (id) => {
                const equip = state.equipment.find(e => e.id === id);
                const statusOptions = Object.keys(statusMap).map(s => `<option value="${s}" ${equip.status === s ? 'selected' : ''}>${statusMap[s].text}</option>`).join('');
                const content = `<form id="editEquipForm" data-id="${id}" class="space-y-3">
                    <input name="name" required value="${equip.name}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input name="serial" required value="${equip.serial}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input name="type" required value="${equip.type}" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <select name="status" class="w-full px-3 py-2 rounded-lg border border-slate-200">${statusOptions}</select>
                    <input name="acquisition_date" type="date" value="${equip.acquisition_date}" required class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input name="price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)" value="${equip.price || ''}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <textarea name="notes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" rows="2" class="w-full px-3 py-2 rounded-lg border border-slate-200">${equip.notes || ''}</textarea>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="editEquipForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
                showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', content, actions);
            };
            window.handleAddUserClick = () => {
                const roleOptions = Object.keys(roleMap).map(r => `<option value="${r}">${roleMap[r]}</option>`).join('');
                const content = `<form id="addUserForm" class="space-y-3">
                    <input name="full_name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-3 py-2 rounded-lg border">
                    <input name="email" type="email" required placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-3 py-2 rounded-lg border">
                    <input name="password" type="password" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ 'password' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Demo)" value="password" class="w-full px-3 py-2 rounded-lg border">
                    <select name="role" class="w-full px-3 py-2 rounded-lg border bg-white">${roleOptions}</select>
                    <input name="agency" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full px-3 py-2 rounded-lg border">
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="addUserForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>`;
                showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà', content, actions);
            };
            window.handleEditUserClick = (id) => {
                const user = [...state.users, ...state.pendingUsers].find(u => u.id === id);
                const roleOptions = Object.keys(roleMap).map(r => `<option value="${r}" ${user.role === r ? 'selected' : ''}>${roleMap[r]}</option>`).join('');
                const canEditSensitive = user.id !== state.user.id;
                const statusOptions = `
                    <option value="active" ${user.status === 'active' ? 'selected' : ''}>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    <option value="pending_approval" ${user.status === 'pending_approval' ? 'selected' : ''}>‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    <option value="deleted" ${user.status === 'deleted' ? 'selected' : ''}>‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</option>
                `;
                const content = `<form id="editUserForm" data-id="${id}" class="space-y-3">
                    <input name="full_name" required value="${user.full_name}" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <label class="text-sm font-medium text-slate-700">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                    <select name="role" ${!canEditSensitive ? 'disabled' : ''} class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white disabled:bg-slate-100">${roleOptions}</select>
                    <label class="text-sm font-medium text-slate-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select name="status" ${!canEditSensitive ? 'disabled' : ''} class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white disabled:bg-slate-100">${statusOptions}</select>
                    ${!canEditSensitive ? '<p class="text-xs text-slate-500">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ</p>' : ''}
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="editUserForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
                showModal(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.full_name}`, content, actions);
            };
            window.handleDeleteUserClick = (id) => {
                const user = [...state.users, ...state.pendingUsers].find(u => u.id === id);
                if (user.id === state.user.id) {
                    toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ', true);
                    return;
                }
                const content = `<p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á <strong>${user.full_name}</strong>? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏ñ‡∏π‡∏Å‡∏•‡∏ö" ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ</p>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                 <button type="button" id="confirmDeleteUserBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>`;
                showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', content, actions);
                $('#confirmDeleteUserBtn').onclick = async () => {
                    user.status = 'deleted';
                    logActivity('DELETE_USER', 'user', user.id, `‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.full_name}`);
                    toast('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    hideModal();
                    fullRender();
                };
            };
            window.handleDeleteEquipmentClick = (id) => {
                const equip = state.equipment.find(e => e.id === id);
                const content = `<form id="deleteEquipForm" data-id="${id}">
                    <p class="text-sm text-slate-700">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <strong class="font-semibold">${equip.name}</strong> (S/N: ${equip.serial})</p>
                    <p class="text-sm text-slate-500 mb-3">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏õ‡πá‡∏ô '‡∏ñ‡∏π‡∏Å‡∏•‡∏ö' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</p>
                    <textarea name="reason" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏ñ‡∏≤‡∏ß‡∏£, ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢..." rows="3" class="w-full px-3 py-2 rounded-lg border border-slate-300"></textarea>
                </form>`;
                 const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="deleteEquipForm" class="px-4 py-2 rounded-lg bg-red-600 text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>`;
                showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', content, actions);
            };
            window.handleReportProblem = () => {
                const content = `<form id="reportProblemForm"><p class="text-sm text-slate-600 mb-3">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤</p><textarea name="problem_description" rows="5" class="w-full px-3 py-2 rounded-lg border border-slate-200" required placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤..."></textarea></form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="reportProblemForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>`;
                showModal('‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞', content, actions);
            };
             async function handleDynamicFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const id = parseInt(form.dataset.id);
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    switch (form.id) {
                        case 'preDeliveryForm': 
                            await api.performPreDeliveryCheck(id, [], {}); 
                            toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); 
                            break;
                        case 'replaceEquipForm':
                             const replacements = Object.keys(data).filter(k => k.startsWith('replacement_')).map(k => {
                                 return { faultyId: parseInt(k.split('_')[1]), newId: parseInt(data[k]) };
                             });
                             await api.performPreDeliveryCheck(id, replacements, {});
                             toast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                             break;
                        case 'postReturnForm':
                            const attachmentFiles = form.querySelector('input[name="attachments"]').files;
                            const attachments = [];
                            if (data.isDamaged === 'true' && attachmentFiles.length > 0) {
                                const promises = Array.from(attachmentFiles).map(file => {
                                    return new Promise((resolve, reject) => {
                                        const reader = new FileReader();
                                        reader.onload = e => resolve(e.target.result);
                                        reader.onerror = e => reject(e);
                                        reader.readAsDataURL(file);
                                    });
                                });
                                const base64strings = await Promise.all(promises);
                                attachments.push(...base64strings);
                            }
                            await api.techInspectReturn(id, data.isDamaged === 'true', data.notes, {}, data.late_return_reason, attachments);
                            toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                            break;
                        case 'completeRepairForm':
                            const repairAttachmentFiles = form.querySelector('input[name="attachments"]').files;
                            const repairAttachments = [];
                            if (repairAttachmentFiles.length > 0) {
                                const promises = Array.from(repairAttachmentFiles).map(file => {
                                    return new Promise((resolve, reject) => {
                                        const reader = new FileReader();
                                        reader.onload = e => resolve(e.target.result);
                                        reader.onerror = e => reject(e);
                                        reader.readAsDataURL(file);
                                    });
                                });
                                const base64strings = await Promise.all(promises);
                                repairAttachments.push(...base64strings);
                            }
                            const repairData = { ...data, attachments: repairAttachments };
                            await api.completeRepair(id, repairData);
                            toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                            break;
                        case 'assessmentForm': await api.createAssessment({ equipment_id: id, ...data }); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'bulkAddEquipForm':
                            const rows = form.querySelectorAll('.equip-row');
                            const newEquips = [];
                            const rowIndices = Array.from(rows).map((row, i) => {
                                const firstInput = row.querySelector('input');
                                return firstInput.name.split('_')[1];
                            });

                            for (const index of rowIndices) {
                                const name = form.querySelector(`input[name="name_${index}"]`).value;
                                const serial = form.querySelector(`input[name="serial_${index}"]`).value;
                                const type = form.querySelector(`input[name="type_${index}"]`).value;
                                const price = form.querySelector(`input[name="price_${index}"]`).value;

                                if (!name || !serial || !type) {
                                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß');
                                }
                                newEquips.push({ name, serial, type, price: Number(price) || 0, notes: '' });
                            }

                            await api.bulkAddEquipment(newEquips);
                            toast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${newEquips.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                            break;
                        case 'editEquipForm': await api.updateEquipment(id, data); toast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'deleteEquipForm': await api.deleteEquipment(id, data.reason); toast('‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); break;
                        case 'bulkDeleteEquipForm':
                             await api.bulkDeleteEquipment([...state.selectedEquipment], data.reason);
                             toast(`‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${state.selectedEquipment.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                             state.selectedEquipment.clear();
                             break;
                        case 'bulkEditStatusForm':
                             await api.bulkUpdateEquipmentStatus([...state.selectedEquipment], data.status);
                             toast(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${state.selectedEquipment.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                             state.selectedEquipment.clear();
                             break;
                        case 'addUserForm':
                             if (state.users.some(u => u.email === data.email) || state.pendingUsers.some(u => u.email === data.email)) throw new Error('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                             const newUser = { id: state.seq.user++, ...data, status: 'active' };
                             state.users.push(newUser);
                             logActivity('CREATE_USER', 'user', newUser.id, `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà: ${newUser.full_name} (${newUser.role})`);
                             toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                             break;
                        case 'editUserForm': 
                             const userToUpdate = [...state.users, ...state.pendingUsers].find(u => u.id === id);
                             if (userToUpdate) {
                                // Prevent self-demotion/deactivation
                                if(userToUpdate.id === state.user.id) {
                                    data.role = state.user.role;
                                    data.status = 'active';
                                }
                                const oldDetails = `Role: ${userToUpdate.role}, Status: ${userToUpdate.status}`;
                                Object.assign(userToUpdate, data);
                                const newDetails = `Role: ${userToUpdate.role}, Status: ${userToUpdate.status}`;
                                logActivity('UPDATE_USER', 'user', id, `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userToUpdate.full_name}. ‡∏à‡∏≤‡∏Å [${oldDetails}] ‡πÄ‡∏õ‡πá‡∏ô [${newDetails}]`);
                                toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                             }
                             break;
                        case 'reportProblemForm':
                            addNotification(`‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å ${state.user.name}: ${data.problem_description}`, ['admin', 'approver']);
                            toast('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞!'); 
                            break;
                    }
                    hideModal();
                    fullRender();
                } catch (err) { toast(err.message, true); }
            }
            async function handleLogin(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); try { const user = await api.login(d.email, d.password); state.user = user; localStorage.setItem('yonchuw_user', JSON.stringify(user)); toast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${user.name}`); show('dashboard'); fullRender(); } catch (err) { toast(err.message, true); } e.target.reset(); }
            async function handleRegister(e) { e.preventDefault(); const d = Object.fromEntries(new FormData(e.target).entries()); if (!d.email.includes('@')) { toast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true); return; } if (d.password.length < 8) { toast('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', true); return; } try { const res = await api.register(d); toast(res.message); show('loginPage'); } catch (err) { toast(err.message, true); } e.target.reset(); }
            function handleLogout() { state.user = null; localStorage.removeItem('yonchuw_user'); toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#demoModeBanner').classList.add('hidden'); show('home'); applyRoleVisibility(); }
            async function handleDemoLogin() { try { const user = await api.login('user@example.com', 'password'); state.user = user; localStorage.setItem('yonchuw_user', JSON.stringify(user)); toast(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ`); show('dashboard'); $('#demoModeBanner').classList.remove('hidden'); fullRender(); } catch (err) { toast(err.message, true); } }
            async function handleBorrowSubmit(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                if ($('#demoModeBanner').classList.contains('hidden') === false) { toast('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); e.target.reset(); return; }
                const formData = new FormData(e.target);
                try {
                    btn.disabled = true;
                    const equipment_requests = [];
                    $$('#borrowEquipTypeList input[type="number"]').forEach(input => {
                        const quantity = parseInt(input.value);
                        if (quantity > 0) {
                            equipment_requests.push({
                                type: input.dataset.type,
                                quantity: quantity
                            });
                        }
                    });

                    const details = Object.fromEntries(formData.entries());
                    const payload = { ...details, equipment_requests, user_id: state.user.id };
                    if (!payload.equipment_requests.length || !payload.borrow_date || !payload.purpose || !payload.contact_name) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
                    
                    await api.createBorrow(payload);
                    toast('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    e.target.reset();
                    fullRender();
                } catch (err) {
                    toast(err.message, true);
                } finally { btn.disabled = false; }
            }
            function handleExitDemo() { state.user = null; localStorage.removeItem('yonchuw_user'); toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); $('#demoModeBanner').classList.add('hidden'); show('home'); applyRoleVisibility(); }

            function applyRoleVisibility() {
                const loggedIn = !!state.user;
                $('#btnLogin').classList.toggle('hidden', loggedIn);
                $('#btnRegister').classList.toggle('hidden', loggedIn);
                $('#userInfo').classList.toggle('hidden', !loggedIn);
                $('#userInfo').classList.toggle('flex', loggedIn);
                const sidebarLogin = $('#sidebarLoginActions');
                const sidebarUserInfo = $('#sidebarUserInfo');
                if (sidebarLogin) sidebarLogin.classList.toggle('hidden', loggedIn);
                if (sidebarUserInfo) {
                    sidebarUserInfo.classList.toggle('hidden', !loggedIn);
                    sidebarUserInfo.classList.toggle('flex', loggedIn);
                }
                const allTabs = [
                    { id: 'equipmentTab', label: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['admin', 'user', 'technician', 'approver'] },
                    { id: 'borrowTab', label: '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['user'] },
                    { id: 'borrowHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', roles: ['user'] },
                    { id: 'approvalTab', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠', roles: ['admin', 'approver'] },
                    { id: 'deliveryTab', label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', roles: ['admin', 'technician'] },
                    { id: 'techTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á', roles: ['admin', 'technician'] },
                    { id: 'repairHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', roles: ['admin', 'technician'] },
                    { id: 'approvalHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', roles: ['admin', 'approver'] },
                    { id: 'assessmentTab', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô', roles: ['admin', 'technician'] },
                    { id: 'assessmentHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', roles: ['admin', 'technician'] },
                    { id: 'reportTab', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', roles: ['admin', 'approver', 'technician'] },
                    { id: 'adminTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', roles: ['admin'] }
                ];
                const desktopTabsContainer = $('#desktopTabs');
                const sidebarNavContainer = $('#sidebarNav');
                if (loggedIn) {
                    $('#userNameDisplay').textContent = state.user.name;
                    $('#sidebarUserNameDisplay').textContent = state.user.name;
                    const role = state.user.role;
                    $('#sidebarUserRoleDisplay').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${roleMap[role] || 'Unknown'}`;
                    const visibleTabs = allTabs.filter(tab => tab.roles.includes(role));
                    if (desktopTabsContainer) desktopTabsContainer.innerHTML = visibleTabs.map(tab => `<button data-tab="${tab.id}" class="tab-btn px-4 py-2 rounded-lg">${tab.label}</button>`).join('');
                    if (sidebarNavContainer) sidebarNavContainer.innerHTML = visibleTabs.map(tab => `<button data-tab="${tab.id}" class="tab-btn w-full text-left px-4 py-2 rounded-lg hover:bg-white/10">${tab.label}</button>`).join('');
                    $('#btnAddEquipDash').classList.toggle('hidden', role !== 'admin');
                    $('#notificationArea').classList.remove('hidden');
                    $('#dashEquipFilter option[value="deleted"]').classList.toggle('hidden', role !== 'admin');

                } else {
                    if (desktopTabsContainer) desktopTabsContainer.innerHTML = '';
                    if (sidebarNavContainer) sidebarNavContainer.innerHTML = '';
                    $('#notificationArea').classList.add('hidden');
                }
            }
             function updateBulkActionUI() {
                const container = $('#bulkActionContainer');
                const countEl = $('#bulkActionCount');
                if (!container || !countEl) return;
                const count = state.selectedEquipment.size;
                if (count > 0) {
                    container.classList.remove('hidden');
                    countEl.textContent = `${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`;
                } else {
                    container.classList.add('hidden');
                }
            }
             window.handleEquipCheckboxChange = (id, isChecked) => {
                if (isChecked) {
                    state.selectedEquipment.add(id);
                } else {
                    state.selectedEquipment.delete(id);
                }
                updateBulkActionUI();
                const card = document.querySelector(`input[onchange="handleEquipCheckboxChange(${id}, this.checked)"]`).closest('.relative.rounded-xl');
                if (card) {
                     card.classList.toggle('border-indigo-500', isChecked);
                     card.classList.toggle('ring-2', isChecked);
                     card.classList.toggle('ring-indigo-200', isChecked);
                     card.classList.toggle('border-slate-200', !isChecked);
                }
            };
            function handleBulkDeleteClick() {
                const selectedIds = [...state.selectedEquipment];
                const items = selectedIds.map(id => state.equipment.find(e => e.id === id));
                const itemListHTML = `<ul class="list-disc list-inside text-sm text-slate-600 bg-slate-50 p-2 rounded-md max-h-40 overflow-y-auto">${items.map(item => `<li>${item.name} (S/N: ${item.serial})</li>`).join('')}</ul>`;
                const content = `<form id="bulkDeleteEquipForm">
                    <p class="text-sm text-slate-700 mb-2">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <strong>${selectedIds.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?</p>
                    ${itemListHTML}
                    <p class="text-sm text-slate-500 my-3">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô '‡∏ñ‡∏π‡∏Å‡∏•‡∏ö' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</p>
                    <textarea name="reason" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏ñ‡∏≤‡∏ß‡∏£, ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢..." rows="3" class="w-full px-3 py-2 rounded-lg border border-slate-300"></textarea>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="bulkDeleteEquipForm" class="px-4 py-2 rounded-lg bg-red-600 text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>`;
                showModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', content, actions);
            }
            function handleBulkEditStatusClick() {
                const selectedIds = [...state.selectedEquipment];
                const statusOptions = Object.keys(statusMap).map(s => `<option value="${s}">${statusMap[s].text}</option>`).join('');
                const items = selectedIds.map(id => state.equipment.find(e => e.id === id));
                const itemListHTML = `<ul class="list-disc list-inside text-sm text-slate-600 bg-slate-50 p-2 rounded-md max-h-40 overflow-y-auto">${items.map(item => `<li>${item.name} (S/N: ${item.serial})</li>`).join('')}</ul>`;
                 const content = `<form id="bulkEditStatusForm">
                    <p class="text-sm text-slate-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <strong>${selectedIds.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</p>
                     ${itemListHTML}
                    <select name="status" class="w-full mt-3 px-3 py-2 rounded-lg border border-slate-300 bg-white">${statusOptions}</select>
                </form>`;
                const actions = `<button type="button" onclick="hideModal()" class="px-4 py-2 rounded-lg bg-slate-100">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" form="bulkEditStatusForm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
                showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', content, actions);
            }
            function setupEventListeners() {
                const addListener = (selector, event, handler) => { const el = $(selector); if (el) { el.addEventListener(event, handler); } };
                const openSidebar = () => { const s = $('#sidebar'); if (s) { s.classList.remove('hidden'); setTimeout(() => { $('#sidebarBackdrop').style.opacity = '1'; $('#sidebarContent').classList.remove('-translate-x-full'); }, 10); } };
                const closeSidebar = () => { const sb = $('#sidebarBackdrop'), sc = $('#sidebarContent'); if (sb && sc) { sb.style.opacity = '0'; sc.classList.add('-translate-x-full'); setTimeout(() => { $('#sidebar').classList.add('hidden'); }, 300); } };
                addListener('#hamburgerBtn', 'click', openSidebar);
                addListener('#sidebarCloseBtn', 'click', closeSidebar);
                addListener('#sidebarBackdrop', 'click', closeSidebar);
                document.body.addEventListener('click', (e) => { const t = e.target; if (t.matches('.tab-btn')) { setTabs(t.dataset.tab); if (window.innerWidth < 768) closeSidebar(); } else if (t.id === 'sidebarBtnLogin') { closeSidebar(); show('loginPage'); } else if (t.id === 'sidebarBtnRegister') { closeSidebar(); show('registerPage'); } });
                addListener('#startBtn', 'click', () => state.user ? show('dashboard') : show('loginPage'));
                addListener('#borrowHistoryFilter', 'click', (e) => { if (e.target.tagName === 'BUTTON') { $$('#borrowHistoryFilter button').forEach(b => b.classList.remove('bg-white', 'shadow')); e.target.classList.add('bg-white', 'shadow'); renderBorrowHistory(); } });
                addListener('#btnAddEquip', 'click', window.handleBulkAddEquipmentClick);
                addListener('#btnAddEquipDash', 'click', window.handleBulkAddEquipmentClick);
                addListener('#exitDemoBtn', 'click', handleExitDemo);
                addListener('#btnLogin', 'click', () => show('loginPage'));
                addListener('#btnRegister', 'click', () => show('registerPage'));
                addListener('#goRegister', 'click', (e) => { e.preventDefault(); show('registerPage'); });
                addListener('#browseBtn', 'click', handleDemoLogin);
                addListener('#backFromEquip', 'click', () => show('home'));
                addListener('#backFromLogin', 'click', () => show('home'));
                addListener('#backFromRegister', 'click', () => show('loginPage'));
                addListener('#btnLogout', 'click', handleLogout);
                addListener('#sidebarBtnLogout', 'click', handleLogout);
                addListener('#reportProblemBtn', 'click', handleReportProblem);
                addListener('#loginForm', 'submit', handleLogin);
                addListener('#registerForm', 'submit', handleRegister);
                addListener('#borrowForm', 'submit', handleBorrowSubmit);
                addListener('#modalClose', 'click', hideModal);
                addListener('#modal', 'click', (e) => { if (e.target.id === 'modal') hideModal() });
                document.addEventListener('submit', (e) => { if (['preDeliveryForm', 'postReturnForm', 'completeRepairForm', 'assessmentForm', 'bulkAddEquipForm', 'editEquipForm', 'replaceEquipForm', 'reportProblemForm', 'deleteEquipForm', 'addUserForm', 'editUserForm', 'bulkDeleteEquipForm', 'bulkEditStatusForm'].includes(e.target.id)) { handleDynamicFormSubmit(e); } });
                addListener('#dashEquipSearch', 'input', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#dashEquipFilter', 'change', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#dashEquipTypeFilter', 'change', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#assessmentTypeFilter', 'change', () => renderEquipmentLists({ forAssessment: true }));
                addListener('#borrowDate', 'change', (e) => { if (e.target.value) { const d = new Date(e.target.value); d.setDate(d.getDate() + 7); $('#dueDate').value = d.toISOString().slice(0, 10); } else { $('#dueDate').value = ''; } });
                addListener('#reportMonthFilter', 'change', renderReports);
                addListener('#exportReportsBtn', 'click', handleExport);

                // Notification Listeners
                addListener('#notificationBtn', 'click', (e) => {
                    e.stopPropagation();
                    const dropdown = $('#notificationDropdown');
                    if (dropdown.classList.contains('hidden')) {
                        openNotifications();
                    } else {
                        closeNotifications();
                    }
                });
                document.addEventListener('click', (e) => {
                    const notificationArea = $('#notificationArea');
                    if (notificationArea && !notificationArea.contains(e.target)) {
                        closeNotifications();
                    }
                });
                
                // Approval History Filters
                addListener('#approvalHistoryActionFilter', 'change', renderApprovalHistory);
                addListener('#approvalHistoryStartDate', 'change', renderApprovalHistory);
                addListener('#approvalHistoryEndDate', 'change', renderApprovalHistory);
                addListener('#approvalHistorySort', 'change', renderApprovalHistory);
                addListener('#resetApprovalHistoryFiltersBtn', 'click', () => {
                    $('#approvalHistoryActionFilter').value = '';
                    $('#approvalHistoryStartDate').value = '';
                    $('#approvalHistoryEndDate').value = '';
                    $('#approvalHistorySort').value = 'newest';
                    renderApprovalHistory();
                });

                // Bulk Action Buttons
                addListener('#bulkDeleteBtn', 'click', handleBulkDeleteClick);
                addListener('#bulkEditStatusBtn', 'click', handleBulkEditStatusClick);

                // Admin Tab Listeners
                addListener('#adminAddUserBtn', 'click', handleAddUserClick);
                addListener('#adminUserSearch', 'input', renderAdminTab);
                addListener('#adminUserRoleFilter', 'change', renderAdminTab);
                addListener('#adminUserStatusFilter', 'change', renderAdminTab);
                addListener('#adminLogSearch', 'input', renderAdminTab);

                // Quantity changer and type selection for borrow form
                addListener('#borrowEquipTypeList', 'click', (e) => {
                    if (e.target.classList.contains('quantity-change-btn')) {
                        const btn = e.target;
                        const change = parseInt(btn.dataset.change);
                        const input = btn.parentElement.querySelector('input[type="number"]');
                        if (!input) return;
                        const currentValue = parseInt(input.value);
                        const max = parseInt(input.max);
                        const min = 1; // Cannot decrement below 1 with buttons

                        let newValue = currentValue + change;

                        if (newValue > max) newValue = max;
                        if (newValue < min) newValue = min; // Enforce min of 1
                        
                        input.value = newValue;
                    }
                });

                addListener('#borrowEquipTypeList', 'change', e => {
                    if (e.target.classList.contains('borrow-type-checkbox')) {
                        const checkbox = e.target;
                        const type = checkbox.dataset.type;
                        const container = checkbox.closest('.borrow-item-container');
                        const selector = container.querySelector(`[data-type-selector="${type}"]`);
                        const input = selector.querySelector('input[type="number"]');

                        if (checkbox.checked) {
                            selector.classList.remove('hidden');
                            selector.classList.add('flex');
                            input.value = 1;
                            container.classList.add('bg-indigo-50', 'border-indigo-200');
                            container.classList.remove('border-transparent');
                        } else {
                            selector.classList.add('hidden');
                            selector.classList.remove('flex');
                            input.value = 0; // Reset to 0 when unchecked
                            container.classList.remove('bg-indigo-50', 'border-indigo-200');
                            container.classList.add('border-transparent');
                        }
                    }
                });
                
                const adminSubTabButtons = {
                    '#adminSubTabUsersBtn': '#adminSubContentUsers',
                    '#adminSubTabGroupsBtn': '#adminSubContentGroups',
                    '#adminSubTabLogBtn': '#adminSubContentLog'
                };
                
                Object.keys(adminSubTabButtons).forEach(btnSelector => {
                    const btn = $(btnSelector);
                    if (btn) {
                        btn.addEventListener('click', () => {
                            Object.values(adminSubTabButtons).forEach(contentSelector => $(contentSelector)?.classList.add('hidden'));
                            $(adminSubTabButtons[btnSelector])?.classList.remove('hidden');

                            Object.keys(adminSubTabButtons).forEach(s => {
                                const b = $(s);
                                if(b) {
                                    b.classList.remove('border-indigo-500', 'font-semibold');
                                    b.classList.add('text-slate-500');
                                }
                            });
                            btn.classList.add('border-indigo-500', 'font-semibold');
                            btn.classList.remove('text-slate-500');
                        });
                    }
                });
            }
             function handleExport() {
                const filterMonth = $('#reportMonthFilter').value;
                const borrowsToExport = filterMonth ? state.borrows.filter(b => b.borrow_date.startsWith(filterMonth)) : state.borrows;
                const repairsToExport = filterMonth ? state.repairs.filter(r => (r.request_date || '').startsWith(filterMonth)) : state.repairs;
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,ID,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡∏ä‡πà‡∏≤‡∏á,‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå,‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢\n";

                borrowsToExport.forEach(b => {
                    const equipNames = b.equipment_ids.map(id => state.equipment.find(e => e.id === id)?.name || id).join('; ');
                    csvContent += `‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°,${b.id},${b.borrow_date},${b.user_name},"${equipNames}","${b.purpose}",0\n`;
                });

                repairsToExport.forEach(r => {
                     csvContent += `‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°,${r.id},${r.request_date || ''},${state.users.find(u => u.id === r.technician_id)?.full_name || ''},"${r.equipment_name}","${r.damage_description}",${r.cost || 0}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `report_${filterMonth || 'all'}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                toast('Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
            function populateBorrowTypeList() {
                const listContainer = $('#borrowEquipTypeList');
                if (!listContainer) return;

                const availableEquipment = state.equipment.filter(e => e.status === 'available');
                const availableTypes = availableEquipment.reduce((acc, equip) => {
                    acc[equip.type] = (acc[equip.type] || 0) + 1;
                    return acc;
                }, {});

                const types = Object.keys(availableTypes).sort();

                if (types.length === 0) {
                    listContainer.innerHTML = `<p class="text-sm text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏°</p>`;
                } else {
                    listContainer.innerHTML = types.map(type => {
                        const count = availableTypes[type];
                        const checkboxId = `borrow-type-${type.replace(/\s+/g, '-')}`; 
                        return `
                            <div class="borrow-item-container p-2 rounded-lg border border-transparent transition-colors" data-type-container="${type}">
                                <div class="flex justify-between items-center">
                                    <label for="${checkboxId}" class="flex flex-grow items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="${checkboxId}" class="borrow-type-checkbox h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300" data-type="${type}">
                                        <div>
                                            <span class="font-medium text-slate-800">${type}</span>
                                            <span class="text-xs text-slate-500 ml-1">(‡∏ß‡πà‡∏≤‡∏á ${count} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</span>
                                        </div>
                                    </label>
                                    <div class="quantity-selector hidden items-center gap-2" data-type-selector="${type}">
                                        <button type="button" class="quantity-change-btn text-lg font-bold w-6 h-6 flex items-center justify-center rounded-full bg-slate-200 hover:bg-slate-300" data-change="-1">-</button>
                                        <input type="number" name="quantity_${type.replace(/\s+/g, '_')}" value="0" min="0" max="${count}" class="w-16 text-center border-slate-300 rounded-md py-1" data-type="${type}" readonly>
                                        <button type="button" class="quantity-change-btn text-lg font-bold w-6 h-6 flex items-center justify-center rounded-full bg-slate-200 hover:bg-slate-300" data-change="1">+</button>
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
                }
            }
            function populateAssessmentFilter() {
                const types = [...new Set(state.equipment.map(e => e.type))];
                const select = $('#assessmentTypeFilter');
                if (select) { select.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>' + types.map(t => `<option value="${t}">${t}</option>`).join(''); }
            }
            function populateEquipmentTypeFilter() {
                const types = [...new Set(state.equipment.map(e => e.type))].sort();
                const select = $('#dashEquipTypeFilter');
                if (select) { 
                    while(select.options.length > 1) { select.remove(1); }
                    select.innerHTML += types.map(t => `<option value="${t}">${t}</option>`).join(''); 
                }
            }
            function fullRender() {
                applyRoleVisibility();
                if (state.user) {
                    const role = state.user.role;
                    let defaultTab = 'equipmentTab';
                    if (role === 'approver') defaultTab = 'approvalTab';
                    if (role === 'user') defaultTab = 'borrowTab';
                    if (role === 'technician') defaultTab = 'deliveryTab';
                    if (role === 'admin') defaultTab = 'adminTab';
                    
                    const currentActiveTab = $('#desktopTabs .bg-white')?.dataset?.tab;
                    const allTabs = [
                        { id: 'equipmentTab', label: '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['admin', 'user', 'technician', 'approver'] },
                        { id: 'borrowTab', label: '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', roles: ['user'] },
                        { id: 'borrowHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°', roles: ['user'] },
                        { id: 'approvalTab', label: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠', roles: ['admin', 'approver'] },
                        { id: 'deliveryTab', label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö', roles: ['admin', 'technician'] },
                        { id: 'techTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á', roles: ['admin', 'technician'] },
                        { id: 'repairHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°', roles: ['admin', 'technician'] },
                        { id: 'approvalHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', roles: ['admin', 'approver'] },
                        { id: 'assessmentTab', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô', roles: ['admin', 'technician'] },
                        { id: 'assessmentHistoryTab', label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', roles: ['admin', 'technician'] },
                        { id: 'reportTab', label: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', roles: ['admin', 'approver', 'technician'] },
                        { id: 'adminTab', label: '‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', roles: ['admin'] }
                    ];
                    const currentTabInfo = allTabs.find(t => t.id === currentActiveTab);
                    if (!currentActiveTab || !currentTabInfo || !currentTabInfo.roles.includes(role)) {
                        setTabs(defaultTab);
                    } else {
                        setTabs(currentActiveTab);
                    }
                    renderSummaries();
                    renderBorrowHistory();
                    renderApprovalLists();
                    renderApprovalHistory();
                    renderTechnicianQueues();
                    renderDeliveryTab();
                    renderRepairHistory();
                    renderReports();
                    renderAdminTab();
                    renderAssessmentHistory();
                    populateBorrowTypeList();
                    populateAssessmentFilter();
                    populateEquipmentTypeFilter();
                    populateApprovalActionFilter();
                    renderNotifications();
                    updateBulkActionUI();
                }
                renderEquipmentLists({ forAssessment: true });
            }
            function init() {
                const savedUser = localStorage.getItem('yonchuw_user');
                if (savedUser) { state.user = JSON.parse(savedUser); show('dashboard'); }
                else { show('home'); }
                setupEventListeners();
                fullRender();
            }
            init();
        });
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>